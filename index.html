<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í–‰ìš´ì˜ ë¡œë˜ ë²ˆí˜¸ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- OCR Library (Tesseract.js) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6413625773978376"
                     crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1547545070-3602e2112613?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        .lotto-ball {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0.25rem;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        /* ì‘ì€ ë¡œë˜ ê³µ (ê¸°ë¡ìš©) - ì‚¬ì´ì¦ˆ í™•ëŒ€ */
        .small-ball {
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
            margin: 0.15rem;
            box-shadow: none;
            animation: none;
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s;
        }
        
        /* ë‹¹ì²¨ ë²ˆí˜¸ ê°•ì¡° íš¨ê³¼ */
        .small-ball.matched {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* ë³´ë„ˆìŠ¤ ë²ˆí˜¸ ê°•ì¡° íš¨ê³¼ (2ë“±ì¼ ë•Œë§Œ ì ìš©ë¨) */
        .small-ball.bonus-matched {
            border: 2px solid #a855f7; /* Purple Border */
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
        }

        /* ë‚™ì²¨ ë²ˆí˜¸ íšŒìƒ‰ ì²˜ë¦¬ */
        .small-ball.dimmed {
            background: #e5e7eb !important;
            background-image: none !important;
            color: #9ca3af !important;
            text-shadow: none !important;
            transform: scale(0.9);
            opacity: 0.7;
        }

        /* ìˆ˜ë™ ì…ë ¥ ëª¨ë‹¬ì˜ ì„ íƒëœ ê³µ */
        .select-ball {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f3f4f6;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }
        .select-ball:hover {
            background-color: #e5e7eb;
        }
        .select-ball.selected {
            border: 2px solid transparent;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .ball-yellow { background: linear-gradient(135deg, #fbc400, #ff9f00); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-blue { background: linear-gradient(135deg, #69c, #007bff); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-red { background: linear-gradient(135deg, #ff7272, #dc3545); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-gray { background: linear-gradient(135deg, #a5a5a5, #6c757d); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-green { background: linear-gradient(135deg, #b0d840, #28a745); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }

        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }

        .history-item {
            transition: all 0.2s;
            position: relative;
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .history-item:hover .delete-btn {
            opacity: 1;
        }

        /* ê²°ê³¼ ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
        .result-banner {
            transition: all 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .result-banner.show {
            max-height: 200px; /* 3ì¤„ ì´ìƒ í…ìŠ¤íŠ¸ë„ ë³´ì´ë„ë¡ ë†’ì´ ì¦ê°€ */
            opacity: 1;
            margin-bottom: 0.25rem;
            padding: 0.25rem;
        }

        #result-modal, #manual-input-modal, #delete-confirm-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        @media (max-width: 640px) {
            .lotto-ball { width: 2.5rem; height: 2.5rem; font-size: 1rem; }
            .small-ball { width: 1.5rem; height: 1.5rem; font-size: 0.75rem; }
            .select-ball { width: 2rem; height: 2rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2">

    <div class="main-container max-w-md w-full rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 text-center shrink-0 flex flex-col items-center">
            <h1 class="text-xl font-bold text-white mb-1">
                ğŸ€ ë¶€ì ë˜ê¸° í”„ë¡œì íŠ¸ ğŸ’¸
            </h1>
            <p class="text-purple-100 text-xs mb-2 italic">"ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì´ ê¹ƒë“¤ê¸°ë¥¼ ë°”ëë‹ˆë‹¤"</p>
            
            <!-- Round Select + Date Display -->
            <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-2 py-1 shadow-inner transition-colors hover:bg-opacity-30 gap-2">
                <div class="flex items-center border-r border-white border-opacity-30 pr-5 relative group cursor-pointer">
                    <span class="text-white text-xs mr-1 font-bold">íšŒì°¨ ì„ íƒ</span>
                    
                    <div class="relative">
                        <select id="round-input" class="w-16 bg-transparent text-white text-right font-bold focus:outline-none text-xs appearance-none cursor-pointer pr-4 relative z-10 transform -translate-y-[1.5px]">
                            <!-- JSë¡œ ì˜µì…˜ ì±„ì›Œì§ -->
                        </select>
                        <i class="fas fa-caret-down text-white text-[10px] absolute right-0 top-1/2 transform -translate-y-1/2 pointer-events-none opacity-70 group-hover:opacity-100"></i>
                    </div>
                    
                    <span class="text-white text-xs ml-1">íšŒ</span>
                </div>
                <!-- Draw Date Display -->
                <span id="draw-date" class="text-white text-xs opacity-90 font-medium"></span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-4 pb-2 shrink-0">
            <!-- Display Area: Can show Balls or Global Result Message -->
            <div id="numbers-container" class="flex flex-col justify-center items-center min-h-[130px] py-6 bg-white bg-opacity-50 rounded-xl px-2 mb-3 border border-gray-100 shadow-sm transition-all overflow-hidden relative">
                <!-- Default Placeholder or Balls -->
                <div id="generated-balls-area" class="flex flex-wrap justify-center items-center w-full gap-2">
                    <span class="text-gray-500 text-xs">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</span>
                </div>
                
                <!-- Global Result Overlay -->
                <div id="global-result-overlay" class="absolute inset-0 bg-white flex flex-col justify-center items-center hidden z-20 pb-4">
                    <h2 id="global-rank-title" class="text-lg font-bold mb-1"></h2>
                    <p id="global-rank-desc" class="text-xs text-gray-500 mb-4 text-center px-4"></p>
                    
                    <!-- ë‹«ê¸° ë²„íŠ¼ -->
                    <button onclick="closeGlobalResult()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-1 px-4 rounded-md text-xs transition shadow-sm border border-gray-300">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex gap-2 mb-2">
                <button onclick="generateLotto()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-lg flex items-center justify-center gap-1 text-xs">
                    <i class="fas fa-sync-alt"></i> ë²ˆí˜¸ ìƒì„±
                </button>
                
                <button onclick="triggerImageUpload()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-lg flex items-center justify-center gap-2" title="ì´ë¯¸ì§€/QR ë²ˆí˜¸ ì¶”ì¶œ">
                    <i class="fas fa-camera"></i>
                </button>
                <input type="file" id="image-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">

                <button onclick="openManualInput()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-lg flex items-center justify-center gap-2" title="ìˆ˜ë™ ì…ë ¥">
                    <i class="fas fa-hand-pointer"></i>
                </button>

                <button onclick="copyNumbers()" id="copy-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-bold py-2 px-3 rounded-xl transition duration-200 border border-gray-200 shadow-sm" title="í´ë¦½ë³´ë“œì— ë³µì‚¬">
                    <i class="far fa-copy"></i>
                </button>
            </div>
        </div>

        <!-- History (Fixed Height Area) -->
        <div class="px-4 pb-0 flex-1 flex flex-col">
            <div class="border-t border-gray-100 pt-2 flex flex-col h-full">
                <div class="flex justify-between items-center mb-2 shrink-0">
                    <h2 class="text-xs font-bold text-gray-600 uppercase tracking-wide flex items-center">
                        <span id="history-round-label">í˜„ì¬</span>ì°¨ ê¸°ë¡
                        <span id="total-count-badge" class="ml-1 text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full">(ì´ 0ê±´)</span>
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="fetchLatestResult()" class="text-xs text-blue-500 hover:text-blue-700 transition flex items-center gap-1 font-bold">
                            <i class="fas fa-trophy"></i> ê²°ê³¼ í™•ì¸
                        </button>
                        <span class="w-px h-3 bg-gray-300"></span>
                        <button onclick="openDeleteConfirmModal('ALL')" class="text-xs text-red-400 hover:text-red-600 transition">íšŒì°¨ ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>
                <!-- Fixed Height Container for History -->
                <div id="history-container" class="relative bg-white bg-opacity-30 rounded-lg border border-gray-100 p-1 mb-2">
                    <div id="history-list" class="space-y-1 h-96 overflow-y-auto custom-scrollbar pr-1">
                        <div id="empty-history-msg" class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="fas fa-clipboard-list text-2xl mb-2 opacity-30"></i>
                            <span class="text-xs">ì•„ì§ ì´ íšŒì°¨ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                        </div>
                    </div>
                    
                    <div id="scan-loader" class="absolute inset-0 bg-white bg-opacity-95 z-10 hidden flex-col items-center justify-center rounded-lg">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-2"></div>
                        <span id="scan-message" class="text-xs text-indigo-600 font-bold">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
                        <span id="scan-sub-message" class="text-[10px] text-gray-400 mt-1">ìˆ«ìë§Œ ì§‘ì¤‘í•´ì„œ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-white bg-opacity-50 p-2 text-center text-xs text-gray-500 border-t border-gray-100 shrink-0">
            <p class="font-bold text-gray-600 mb-1">Good Luck! ğŸ€</p>
            <p class="text-[10px] text-gray-400 flex items-center justify-center gap-1">
                Created by 
                <a href="mailto:mecca0515@gmail.com" class="font-bold text-indigo-500 hover:text-indigo-700 flex items-center gap-1 transition" title="ì œì‘ìì—ê²Œ ë©”ì¼ ë³´ë‚´ê¸°">
                    mecca0515 <i class="fas fa-envelope text-[9px]"></i>
                </a>
                <span class="w-1 h-1 bg-gray-300 rounded-full mx-1"></span> 
                with <span class="font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Gemini</span> âœ¨
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-sm whitespace-nowrap">
        ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">ë‹¹ì²¨ ê²°ê³¼ í™•ì¸</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-content" class="text-center">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <div id="manual-input-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-4 max-w-sm w-full mx-4 flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold text-gray-800">ë²ˆí˜¸ ì§ì ‘ ì…ë ¥</h3>
                <button onclick="closeManualInput()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="text-center mb-2 shrink-0">
                <span id="manual-count" class="text-sm font-bold text-indigo-600">0</span>
                <span class="text-sm text-gray-500">/ 6ê°œ ì„ íƒë¨</span>
            </div>

            <!-- Number Grid -->
            <div class="grid grid-cols-7 gap-2 overflow-y-auto p-1 custom-scrollbar flex-1 mb-4">
                <!-- JS will populate this -->
            </div>

            <div class="flex gap-2 shrink-0">
                <button onclick="resetManualSelection()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition text-sm">
                    ì´ˆê¸°í™”
                </button>
                <button onclick="saveManualInput()" id="manual-save-btn" class="flex-[2] bg-gray-300 text-white font-bold py-3 px-4 rounded-xl transition text-sm cursor-not-allowed" disabled>
                    ì…ë ¥ ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal (Shared) -->
    <div id="delete-confirm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <h3 id="delete-modal-title" class="text-lg font-bold text-gray-800 mb-2">ğŸ—‘ï¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</h3>
            <p id="delete-modal-desc" class="text-gray-600 mb-6 text-sm">ì •ë§ ëª¨ë“  ë²ˆí˜¸ ìƒì„± ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteConfirmModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition text-sm">
                    ì·¨ì†Œ
                </button>
                <button onclick="confirmDelete()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition text-sm">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Canvas for Image Processing -->
    <canvas id="scan-canvas" class="hidden"></canvas>

    <script>
        let currentNumbers = [];
        let manualSelection = new Set();
        // State Management
        let historyData = []; 
        let winResults = {}; 
        let currentRound = 0;
        let deleteTargetId = null; 

        // Pagination State
        let displayedCount = 0;
        const PAGE_SIZE = 20;
        let currentFilteredGames = [];
        let currentWinData = null; 

        const historyList = document.getElementById('history-list');
        const emptyMsg = document.getElementById('empty-history-msg');
        const container = document.getElementById('numbers-container');
        const generatedBallsArea = document.getElementById('generated-balls-area');
        const globalResultOverlay = document.getElementById('global-result-overlay');
        const globalRankTitle = document.getElementById('global-rank-title');
        const globalRankDesc = document.getElementById('global-rank-desc');
        const totalCountBadge = document.getElementById('total-count-badge');
        
        const resultModal = document.getElementById('result-modal');
        const manualInputModal = document.getElementById('manual-input-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalDesc = document.getElementById('delete-modal-desc');

        const modalContent = document.getElementById('modal-content');
        const scanLoader = document.getElementById('scan-loader');
        const scanMessage = document.getElementById('scan-message');
        const scanSubMessage = document.getElementById('scan-sub-message');
        const roundInput = document.getElementById('round-input');
        const historyRoundLabel = document.getElementById('history-round-label');
        const drawDateSpan = document.getElementById('draw-date');

        // --- Initialization ---
        function init() {
            const storedHistory = localStorage.getItem('lotto_history');
            if (storedHistory) {
                historyData = JSON.parse(storedHistory);
            }

            const storedWinResults = localStorage.getItem('lotto_win_results');
            if (storedWinResults) {
                winResults = JSON.parse(storedWinResults);
            }

            const latestRound = calculateCurrentRound();
            // ìˆ˜ì •: ë¯¸ë˜ íšŒì°¨ ì œì™¸í•˜ê³  ë”± ì´ë²ˆì£¼ê¹Œì§€ë§Œ
            populateRoundSelect(latestRound);

            const storedRound = localStorage.getItem('lotto_current_round');
            if (storedRound) {
                currentRound = parseInt(storedRound);
                if(currentRound > latestRound) currentRound = latestRound;
            } else {
                currentRound = latestRound; 
            }
            
            roundInput.value = currentRound;
            updateRoundInfo(currentRound);

            renderHistory(currentRound);

            historyList.addEventListener('scroll', () => {
                if (historyList.scrollTop + historyList.clientHeight >= historyList.scrollHeight - 50) {
                    loadMoreHistory();
                }
            });
        }

        function calculateCurrentRound() {
            const startDate = new Date('2002-12-07T00:00:00'); 
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const diffDays = diffTime / (1000 * 60 * 60 * 24); 
            // ìˆ˜ì •: (diffDays - 1) / 7 + 2 ë¡œì§ìœ¼ë¡œ ì´ë²ˆì£¼ í† ìš”ì¼(1207)ì´ ë‚˜ì˜¤ë„ë¡ í•¨
            return Math.floor((diffDays - 1) / 7) + 2;
        }

        function populateRoundSelect(maxRound) {
            roundInput.innerHTML = '';
            for (let i = maxRound; i >= 1; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                option.className = "text-gray-800";
                roundInput.appendChild(option);
            }
        }

        function updateRoundInfo(round) {
            historyRoundLabel.textContent = `${round}íšŒ`;
            
            const startDate = new Date('2002-12-07T00:00:00');
            const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
            
            const year = drawDate.getFullYear();
            const month = String(drawDate.getMonth() + 1).padStart(2, '0');
            const day = String(drawDate.getDate()).padStart(2, '0');
            
            drawDateSpan.textContent = `(${year}-${month}-${day})`;
        }

        roundInput.addEventListener('change', (e) => {
            let val = parseInt(e.target.value);
            currentRound = val;
            
            updateRoundInfo(val);
            
            localStorage.setItem('lotto_current_round', currentRound);
            renderHistory(currentRound);
            closeGlobalResult();
        });

        function addGameToData(numbers, tag) {
            const game = {
                id: Date.now() + Math.random(), 
                round: currentRound,
                numbers: numbers,
                tag: tag,
                date: new Date().toISOString()
            };
            
            historyData.unshift(game);
            saveHistory();
            renderHistory(currentRound);
        }

        function deleteGameFromData(id) {
            historyData = historyData.filter(game => game.id !== id);
            saveHistory();
            renderHistory(currentRound);
        }

        // ìˆ˜ì •: í˜„ì¬ íšŒì°¨ ë°ì´í„°ë§Œ ì‚­ì œí•˜ë„ë¡ ë³€ê²½
        function clearCurrentRoundHistory() {
            historyData = historyData.filter(game => game.round !== currentRound);
            saveHistory();
            renderHistory(currentRound);
        }

        // êµ¬ë²„ì „ ì „ì²´ ì‚­ì œ í•¨ìˆ˜ ì œê±°í•˜ê³  ìœ„ í•¨ìˆ˜ ì‚¬ìš©
        function clearAllHistoryData() {
            clearCurrentRoundHistory();
        }

        function saveHistory() {
            localStorage.setItem('lotto_history', JSON.stringify(historyData));
        }

        function renderHistory(round) {
            historyList.innerHTML = ''; 
            displayedCount = 0;
            currentWinData = winResults[round] || null; 

            currentFilteredGames = historyData.filter(game => game.round === round);
            
            totalCountBadge.textContent = `(ì´ ${currentFilteredGames.length}ê±´)`;

            if (currentFilteredGames.length === 0) {
                historyList.innerHTML = `
                    <div id="empty-history-msg" class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                        <i class="fas fa-clipboard-list text-2xl mb-2 opacity-30"></i>
                        <span class="text-xs">${round}íšŒì°¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                    </div>
                `;
                return;
            }

            loadMoreHistory();

            if (currentWinData) {
                 calculateAndShowSummary(currentWinData);
            }
        }

        function loadMoreHistory() {
            const nextBatch = currentFilteredGames.slice(displayedCount, displayedCount + PAGE_SIZE);
            
            if(nextBatch.length === 0) return;

            const fragment = document.createDocumentFragment();
            nextBatch.forEach(game => {
                const item = createHistoryItemElement(game);
                
                if(currentWinData) {
                    const winArr = [
                        currentWinData.drwtNo1, currentWinData.drwtNo2, currentWinData.drwtNo3, 
                        currentWinData.drwtNo4, currentWinData.drwtNo5, currentWinData.drwtNo6
                    ];
                    applyWinStyleToItem(item, winArr, currentWinData.bnusNo, game.numbers);
                }
                
                fragment.appendChild(item);
            });
            
            historyList.appendChild(fragment);
            displayedCount += nextBatch.length;
        }

        function applyWinStyleToItem(item, winArr, bonus, myNumbers) {
            let matchCount = 0;
            let isBonusMatched = false;
            
            // 1. Calculate Rank First
            myNumbers.forEach(num => {
                if (winArr.includes(num)) matchCount++;
                else if (num === bonus) isBonusMatched = true;
            });

            let rank = 6;
            if (matchCount === 6) rank = 1;
            else if (matchCount === 5 && isBonusMatched) rank = 2;
            else if (matchCount === 5) rank = 3;
            else if (matchCount === 4) rank = 4;
            else if (matchCount === 3) rank = 5;

            // 2. Apply Styles based on Rank
            const ballElements = item.querySelectorAll('.ball-container .lotto-ball');
            
            ballElements.forEach(ball => {
                const num = parseInt(ball.dataset.num);
                
                if (winArr.includes(num)) {
                    // Main numbers are always matched (colored)
                    ball.classList.add('matched');
                    ball.classList.remove('dimmed');
                } else if (num === bonus) {
                    // Bonus number only colored if Rank 2
                    if (rank === 2) {
                        ball.classList.add('bonus-matched');
                        ball.classList.remove('dimmed');
                    } else {
                        // Otherwise treat as miss
                        ball.classList.remove('matched');
                        ball.classList.remove('bonus-matched');
                        ball.classList.add('dimmed');
                    }
                } else {
                    // Missed
                    ball.classList.remove('matched');
                    ball.classList.remove('bonus-matched');
                    ball.classList.add('dimmed');
                }
            });

            let rankText = '';
            let rankClass = 'text-gray-400 pl-2 border-l border-gray-300'; 

            if (rank === 1) { 
                rankText = 'ğŸ† 1ë“± ë‹¹ì²¨!';
                rankClass = 'text-red-600 pl-2 border-l border-red-200';
            }
            else if (rank === 2) { 
                rankText = 'ğŸ¥ˆ 2ë“± ë‹¹ì²¨!';
                rankClass = 'text-orange-600 pl-2 border-l border-orange-200';
            }
            else if (rank === 3) { 
                rankText = 'ğŸ¥‰ 3ë“± ë‹¹ì²¨!';
                rankClass = 'text-yellow-600 pl-2 border-l border-yellow-200';
            }
            else if (rank === 4) { 
                rankText = '4ë“± (5ë§Œì›)';
                rankClass = 'text-blue-600 pl-2 border-l border-blue-200';
            }
            else if (rank === 5) { 
                rankText = '5ë“± (5ì²œì›)';
                rankClass = 'text-green-600 pl-2 border-l border-green-200';
            }
            else { 
                // ìˆ˜ì •: ë‚™ì²¨ ë¬¸êµ¬ ê°„ì†Œí™”
                rankText = 'ë‚™ì²¨';
                rankClass = 'text-gray-400 pl-2 border-l border-gray-300'; 
            }

            const rankBadge = item.querySelector('.rank-badge');
            if (rankBadge) {
                rankBadge.textContent = rankText;
                rankBadge.className = `rank-badge text-[10px] font-bold ml-2 ${rankClass}`;
                rankBadge.classList.remove('hidden');
            }
        }

        function calculateAndShowSummary(winData) {
            const winArr = [
                winData.drwtNo1, winData.drwtNo2, winData.drwtNo3, 
                winData.drwtNo4, winData.drwtNo5, winData.drwtNo6
            ];
            const bonus = winData.bnusNo;
            
            let counts = { 1:0, 2:0, 3:0, 4:0, 5:0, fail:0 };
            let bestRank = 6;

            currentFilteredGames.forEach(game => {
                const nums = game.numbers;
                let matches = nums.filter(n => winArr.includes(n)).length;
                let bonusMatch = nums.includes(bonus);
                
                let rank = 6;
                if(matches === 6) rank = 1;
                else if(matches === 5 && bonusMatch) rank = 2;
                else if(matches === 5) rank = 3;
                else if(matches === 4) rank = 4;
                else if(matches === 3) rank = 5;
                
                if(rank < 6) counts[rank]++;
                else counts.fail++;

                if(rank < bestRank) bestRank = rank;
            });

            const totalWins = counts[1] + counts[2] + counts[3] + counts[4] + counts[5];
            displayGlobalResult(bestRank, totalWins, counts);
        }

        function displayGlobalResult(bestRank, totalWins, counts) {
            let title = "";
            let desc = "";
            let colorClass = "";

            if (bestRank === 1) {
                title = "ğŸ€ ëŒ€ë°•! 1ë“± ë‹¹ì²¨! ğŸ€";
                desc = "ì˜¤ëŠ˜ì´ ë°”ë¡œ ê·¸ë‚ ì…ë‹ˆë‹¤! ì¸ìƒ ì—­ì „ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!";
                colorClass = "text-yellow-600";
            } else if (bestRank === 2) {
                title = "ğŸ€ 2ë“± ë‹¹ì²¨! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ€";
                desc = "ì •ë§ ì•„ê¹ì§€ë§Œ ëŒ€ë‹¨í•œ ê²°ê³¼ì…ë‹ˆë‹¤! ì¶•í•˜ë“œë ¤ìš”!";
                colorClass = "text-gray-600";
            } else if (bestRank === 3) {
                title = "ğŸ€ 3ë“± ë‹¹ì²¨! ğŸ€";
                desc = "ìš´ì´ ì¢‹ìœ¼ì‹œë„¤ìš”! ë§›ìˆëŠ” ê±° ì‚¬ë“œì„¸ìš”.";
                colorClass = "text-orange-600";
            } else if (bestRank === 4) {
                title = "ğŸ€ 4ë“± ë‹¹ì²¨ ğŸ€";
                desc = "ì†Œì†Œí•œ í–‰ë³µ! 5ë§Œì› ì¶•í•˜ë“œë ¤ìš”.";
                colorClass = "text-blue-600";
            } else if (bestRank === 5) {
                title = "ğŸ€ 5ë“± ë‹¹ì²¨ ğŸ€";
                desc = "ë³¸ì „ì€ ì°¾ìœ¼ì…¨ë„¤ìš”! ë‹¤ìŒì„ ë…¸ë ¤ë³´ì„¸ìš”.";
                colorClass = "text-green-600";
            } else {
                title = "ê½.. ë‹¤ìŒ ê¸°íšŒì—.. ğŸ˜­";
                desc = "ì•„ì‰½ì§€ë§Œ ì´ë²ˆì—” ìš´ì´ ì—†ì—ˆë„¤ìš”. í˜ë‚´ì„¸ìš”!";
                colorClass = "text-gray-500";
            }
            
            if (totalWins > 0) {
                 let summary = `ì´ <b class="text-indigo-600">${totalWins}</b>ê±´ ë‹¹ì²¨! (`;
                 let details = [];
                 if(counts[1] > 0) details.push(`1ë“±:${counts[1]}ê±´`);
                 if(counts[2] > 0) details.push(`2ë“±:${counts[2]}ê±´`);
                 if(counts[3] > 0) details.push(`3ë“±:${counts[3]}ê±´`);
                 if(counts[4] > 0) details.push(`4ë“±:${counts[4]}ê±´`);
                 if(counts[5] > 0) details.push(`5ë“±:${counts[5]}ê±´`);
                 summary += details.join(', ') + ")";
                 
                 desc += `<br><span class="mt-1 block text-gray-600 text-xs">${summary}</span>`;
            }

            showGlobalResult(title, desc, colorClass);
        }

        function createHistoryItemElement(game) {
            const item = document.createElement('div');
            item.dataset.numbers = JSON.stringify(game.numbers);
            item.dataset.id = game.id;
            item.className = 'history-item bg-white bg-opacity-80 p-2 rounded-lg border border-gray-100 flex flex-col shadow-sm items-start';
            
            const contentRow = document.createElement('div');
            contentRow.className = 'flex justify-between w-full items-center';

            const leftDiv = document.createElement('div');
            leftDiv.className = 'flex flex-col';

            const ballsContainer = document.createElement('div');
            ballsContainer.className = 'flex ball-container items-center gap-1';
            game.numbers.forEach(num => {
                const smallBall = document.createElement('div');
                smallBall.className = `lotto-ball small-ball ${getBallColorClass(num)}`;
                smallBall.textContent = num;
                smallBall.dataset.num = num;
                ballsContainer.appendChild(smallBall);
            });
            leftDiv.appendChild(ballsContainer);
            
            if (game.tag) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'flex items-center mt-1 ml-1 meta-info';
                
                const tagSpan = document.createElement('span');
                let colorClass = 'text-gray-400';
                let icon = '';
                
                if (game.tag.includes('ìŠ¤ìº”') || game.tag.includes('ë¶„ì„') || game.tag.includes('Detect')) {
                    colorClass = 'text-teal-600';
                    icon = 'âš¡ ';
                } else if (game.tag.includes('ìˆ˜ë™')) {
                    colorClass = 'text-orange-500';
                    icon = 'ğŸ‘† ';
                }

                tagSpan.className = `text-[10px] font-bold ${colorClass}`;
                tagSpan.textContent = icon + game.tag;
                metaDiv.appendChild(tagSpan);

                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-badge text-[10px] font-bold ml-2 hidden'; 
                metaDiv.appendChild(rankSpan);

                leftDiv.appendChild(metaDiv);
            }

            const rightDiv = document.createElement('div');
            rightDiv.className = 'flex flex-col items-end gap-1';

            const dateObj = new Date(game.date);
            const timeStr = dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-400 whitespace-nowrap';
            timeSpan.textContent = timeStr;
            rightDiv.appendChild(timeSpan);

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn text-gray-400 hover:text-red-500 p-1';
            delBtn.innerHTML = '<i class="fas fa-trash-alt text-xs"></i>';
            delBtn.onclick = function() {
                openDeleteConfirmModal('SINGLE', game.id);
            };
            rightDiv.appendChild(delBtn);

            contentRow.appendChild(leftDiv);
            contentRow.appendChild(rightDiv);
            item.appendChild(contentRow);
            
            return item;
        }

        function generateLotto() {
            closeGlobalResult(); 
            const numbers = new Set();
            while (numbers.size < 6) {
                numbers.add(Math.floor(Math.random() * 45) + 1);
            }
            currentNumbers = Array.from(numbers).sort((a, b) => a - b);
            
            displayNumbers(currentNumbers);
            addGameToData(currentNumbers, "ìë™ ìƒì„±");
        }

        function getBallColorClass(num) {
            num = parseInt(num);
            if (num <= 10) return 'ball-yellow';
            if (num <= 20) return 'ball-blue';
            if (num <= 30) return 'ball-red';
            if (num <= 40) return 'ball-gray';
            return 'ball-green';
        }

        function displayNumbers(numbers) {
            generatedBallsArea.innerHTML = '';
            numbers.forEach((num, index) => {
                const ball = document.createElement('div');
                ball.className = `lotto-ball ${getBallColorClass(num)}`;
                ball.textContent = num;
                ball.style.animationDelay = `${index * 0.1}s`;
                generatedBallsArea.appendChild(ball);
            });
        }

        function showGlobalResult(bestRankText, desc, colorClass) {
            globalRankTitle.textContent = bestRankText;
            globalRankTitle.className = `text-2xl font-bold mb-1 ${colorClass}`;
            globalRankDesc.innerHTML = desc; 
            
            globalResultOverlay.classList.remove('hidden');
            globalResultOverlay.style.opacity = '0';
            setTimeout(() => {
                globalResultOverlay.style.transition = 'opacity 0.3s';
                globalResultOverlay.style.opacity = '1';
            }, 10);
        }

        function closeGlobalResult() {
            globalResultOverlay.classList.add('hidden');
        }

        function openDeleteConfirmModal(type, id = null) {
            if (type === 'ALL' && historyData.length === 0) {
                showToast("ì‚­ì œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            deleteTargetId = id; 

            if (type === 'ALL') {
                deleteModalTitle.textContent = "ğŸ—‘ï¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ";
                deleteModalDesc.innerHTML = "ì •ë§ ëª¨ë“  ë²ˆí˜¸ ìƒì„± ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            } else {
                deleteModalTitle.textContent = "ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ";
                deleteModalDesc.innerHTML = "ì„ íƒí•œ ë²ˆí˜¸ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            }

            deleteConfirmModal.classList.remove('hidden');
            setTimeout(() => {
                deleteConfirmModal.classList.add('opacity-100');
                deleteConfirmModal.querySelector('div').classList.remove('scale-95');
                deleteConfirmModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.classList.remove('opacity-100');
            deleteConfirmModal.querySelector('div').classList.remove('scale-100');
            deleteConfirmModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                deleteConfirmModal.classList.add('hidden');
            }, 300);
            deleteTargetId = null;
        }

        function confirmDelete() {
            if (deleteTargetId) {
                deleteGameFromData(deleteTargetId);
                showToast("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                clearAllHistoryData();
                generatedBallsArea.innerHTML = '<span class="text-gray-500 text-xs">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</span>';
                currentNumbers = [];
                showToast("ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            closeDeleteConfirmModal();
        }

        function copyNumbers() {
            if (currentNumbers.length === 0) {
                showToast("ë¨¼ì € ë²ˆí˜¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
                return;
            }
            const textToCopy = currentNumbers.join(', ');
            
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast("ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + textToCopy);
            } catch (err) {
                showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
            document.body.removeChild(textArea);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            if (isError) {
                toast.classList.remove('bg-gray-800');
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.remove('bg-red-600');
                toast.classList.add('bg-gray-800');
            }
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2500);
        }

        function openManualInput() {
            manualSelection = new Set();
            updateManualUI();
            
            const grid = manualInputModal.querySelector('.grid');
            grid.innerHTML = '';
            for(let i=1; i<=45; i++) {
                const btn = document.createElement('div');
                btn.className = 'select-ball';
                btn.textContent = i;
                btn.onclick = () => toggleManualNumber(i, btn);
                grid.appendChild(btn);
            }

            manualInputModal.classList.remove('hidden');
            setTimeout(() => {
                manualInputModal.classList.add('opacity-100');
                manualInputModal.querySelector('div').classList.remove('scale-95');
                manualInputModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function toggleManualNumber(num, btn) {
            if (manualSelection.has(num)) {
                manualSelection.delete(num);
                btn.classList.remove('selected');
                btn.style.background = '';
                btn.style.border = '';
            } else {
                if (manualSelection.size >= 6) {
                    showToast("6ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", true);
                    return;
                }
                manualSelection.add(num);
                btn.classList.add('selected');
                if (num <= 10) btn.style.background = '#fbc400';
                else if (num <= 20) btn.style.background = '#69c';
                else if (num <= 30) btn.style.background = '#ff7272';
                else if (num <= 40) btn.style.background = '#a5a5a5';
                else btn.style.background = '#b0d840';
                btn.style.borderColor = 'transparent';
            }
            updateManualUI();
        }

        function updateManualUI() {
            document.getElementById('manual-count').textContent = manualSelection.size;
            const saveBtn = document.getElementById('manual-save-btn');
            if (manualSelection.size === 6) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        function resetManualSelection() {
            manualSelection.clear();
            const btns = manualInputModal.querySelectorAll('.select-ball');
            btns.forEach(btn => {
                btn.classList.remove('selected');
                btn.style.background = '';
                btn.style.borderColor = '';
            });
            updateManualUI();
        }

        function saveManualInput() {
            if (manualSelection.size !== 6) return;
            currentNumbers = Array.from(manualSelection).sort((a, b) => a - b);
            displayNumbers(currentNumbers);
            addGameToData(currentNumbers, "ìˆ˜ë™ ì…ë ¥");
            closeManualInput();
            showToast("ìˆ˜ë™ ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        function closeManualInput() {
            manualInputModal.classList.remove('opacity-100');
            manualInputModal.querySelector('div').classList.remove('scale-100');
            manualInputModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                manualInputModal.classList.add('hidden');
            }, 300);
        }

        function triggerImageUpload() {
            document.getElementById('image-input').click();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            scanLoader.style.display = 'flex'; 
            scanMessage.textContent = "ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì¤‘...";
            scanSubMessage.textContent = "ê°€ë…ì„±ì„ ë†’ì´ê³  ìˆìŠµë‹ˆë‹¤";

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    processImage(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function processImage(img) {
            const canvas = document.getElementById('scan-canvas');
            const context = canvas.getContext('2d');
            
            const scaleFactor = 2; 
            canvas.width = img.width * scaleFactor;
            canvas.height = img.height * scaleFactor;
            context.scale(scaleFactor, scaleFactor);
            context.drawImage(img, 0, 0);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                const parsedGames = parseLottoQR(code.data);
                if (parsedGames && parsedGames.length > 0) {
                    finishScan(parsedGames, "QR ìŠ¤ìº”");
                    return;
                }
            }

            const d = imageData.data;
            for (let i = 0; i < d.length; i += 4) {
                const r = d[i];
                const g = d[i+1];
                const b = d[i+2];
                const v = 0.2126*r + 0.7152*g + 0.0722*b;
                d[i] = d[i+1] = d[i+2] = v;
            }
            context.putImageData(imageData, 0, 0);

            scanMessage.textContent = "ìˆ«ì ì •ë°€ ë¶„ì„ ì¤‘...";
            scanSubMessage.textContent = "2ë°° í™•ëŒ€í•˜ì—¬ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
            runOCR(canvas.toDataURL());
        }

        async function runOCR(imageSrc) {
            try {
                const worker = await Tesseract.createWorker('eng');
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDE0123456789\n ', 
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK, 
                });

                const { data: { text } } = await worker.recognize(imageSrc);
                const extractedGames = parseOCRText(text);
                
                if (extractedGames.length > 0) {
                    finishScan(extractedGames, "ì´ë¯¸ì§€ ë¶„ì„");
                } else {
                    scanLoader.style.display = 'none';
                    showToast("ìˆ«ìë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ì…ë ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”!", true);
                }
                await worker.terminate();
            } catch (err) {
                console.error(err);
                scanLoader.style.display = 'none';
                showToast("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
            }
        }

        function parseOCRText(text) {
            let games = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const matches = line.match(/\b\d{1,2}\b/g);
                if (!matches) return;
                
                const validNums = matches.map(n => parseInt(n)).filter(n => n >= 1 && n <= 45);
                const uniqueNums = [...new Set(validNums)];
                
                if (uniqueNums.length >= 6) {
                    const gameNums = uniqueNums.slice(0, 6).sort((a, b) => a - b);
                    let label = `Auto Detect ${games.length + 1}`;
                    const labelMatch = line.match(/[A-E]\b/); 
                    if (labelMatch) label = labelMatch[0];
                    
                    games.push({
                        label: label,
                        numbers: gameNums
                    });
                }
            });

            if (games.length === 0) {
                const allMatches = text.match(/\b\d{1,2}\b/g);
                if (allMatches) {
                    const allValidNums = allMatches.map(n => parseInt(n)).filter(n => n >= 1 && n <= 45);
                    let currentBuffer = [];
                    for (let i = 0; i < allValidNums.length; i++) {
                        const num = allValidNums[i];
                        if (!currentBuffer.includes(num)) currentBuffer.push(num);
                        if (currentBuffer.length === 6) {
                            games.push({
                                label: `Auto Detect ${games.length + 1}`,
                                numbers: [...currentBuffer].sort((a, b) => a - b)
                            });
                            currentBuffer = []; 
                        }
                    }
                }
            }
            return games;
        }

        function finishScan(games, method) {
            scanLoader.style.display = 'none';
            closeGlobalResult();
            
            if (games.length > 0) {
                currentNumbers = games[0].numbers;
                displayNumbers(currentNumbers);
            }
            for (let i = games.length - 1; i >= 0; i--) {
                const label = games[i].label.replace('Game ', '').replace('Auto Detect ', 'ìë™ '); 
                addGameToData(games[i].numbers, `${method} ${label}`);
            }
            showToast(`${games.length}ê°œì˜ ê²Œì„ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤!`);
        }

        function parseLottoQR(url) {
            try {
                if (!url.includes('dhlottery.co.kr') || !url.includes('v=')) return null;
                let params = url.split('v=')[1];
                if (!params) return null;
                if (params.includes('&')) params = params.split('&')[0];
                const cleanStr = params.replace(/[^0-9]/g, '');
                if (cleanStr.length < 16) return null; 

                const numbersStr = cleanStr.substring(4);
                const games = [];
                const gameLabels = ['A', 'B', 'C', 'D', 'E'];
                
                for (let i = 0; i < numbersStr.length; i += 12) {
                    const chunk = numbersStr.substring(i, i + 12);
                    if (chunk.length < 12) break;
                    const nums = [];
                    for (let j = 0; j < 12; j += 2) nums.push(parseInt(chunk.substring(j, j + 2)));
                    if (nums.some(n => n < 1 || n > 45)) continue;
                    games.push({
                        label: gameLabels[games.length] || '?',
                        numbers: nums.sort((a, b) => a - b)
                    });
                    if (games.length >= 5) break; 
                }
                return games;
            } catch (e) { return null; }
        }

        async function fetchLatestResult() {
            const round = document.getElementById('round-input').value;
            
            if (winResults[round]) {
                localStorage.setItem('lotto_current_round', round); 
                showModal();
                const cachedData = winResults[round];
                renderModalContent(cachedData);
                const winArr = [
                    cachedData.drwtNo1, cachedData.drwtNo2, cachedData.drwtNo3, 
                    cachedData.drwtNo4, cachedData.drwtNo5, cachedData.drwtNo6
                ];
                currentWinData = cachedData; 
                checkWinningsInHistory(winArr, cachedData.bnusNo, true); 
                return;
            }

            showModal();
            modalContent.innerHTML = `
                <div class="animate-pulse flex space-x-2 justify-center items-center h-16">
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                </div>
                <p class="text-gray-500 text-sm mt-2">${round}íšŒì°¨ ê²°ê³¼ í™•ì¸ ì¤‘...</p>
            `;

            const startDate = new Date('2002-12-07T00:00:00');
            const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
            drawDate.setHours(21, 0, 0, 0); 
            const now = new Date();

            if (drawDate > now) {
                modalContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clock text-4xl text-gray-300 mb-2"></i>
                        <h4 class="text-lg font-bold text-gray-700">ì¶”ì²¨ ëŒ€ê¸° ì¤‘</h4>
                        <p class="text-gray-500 text-sm mt-1">${round}íšŒì°¨ ì¶”ì²¨ì¼ì€<br>${drawDate.toLocaleDateString()} ì…ë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            try {
                const timestamp = new Date().getTime();
                const targetUrl = `https://www.dhlottery.co.kr/lt645/selectPstLt645Info.do?srchLtEpsd=${round}&_=${timestamp}`;
                
                // Direct fetch
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const jsonResponse = await response.json();

                if (jsonResponse.data && jsonResponse.data.list && jsonResponse.data.list.length > 0) {
                    const lottoData = jsonResponse.data.list[0];
                    const dateStr = String(lottoData.ltRflYmd);
                    const formattedDate = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;

                    const mappedData = {
                        drwNo: lottoData.ltEpsd,
                        drwNoDate: formattedDate,
                        drwtNo1: lottoData.tm1WnNo,
                        drwtNo2: lottoData.tm2WnNo,
                        drwtNo3: lottoData.tm3WnNo,
                        drwtNo4: lottoData.tm4WnNo,
                        drwtNo5: lottoData.tm5WnNo,
                        drwtNo6: lottoData.tm6WnNo,
                        bnusNo: lottoData.bnsWnNo
                    };

                    winResults[round] = mappedData;
                    localStorage.setItem('lotto_win_results', JSON.stringify(winResults));
                    localStorage.setItem('lotto_current_round', round); 
                    
                    currentWinData = mappedData; 

                    renderModalContent(mappedData);
                    
                    const winArr = [
                        mappedData.drwtNo1, mappedData.drwtNo2, mappedData.drwtNo3, 
                        mappedData.drwtNo4, mappedData.drwtNo5, mappedData.drwtNo6
                    ];
                    checkWinningsInHistory(winArr, mappedData.bnusNo, true);
                } else {
                    throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.warn("Lotto API Direct Fetch Failed:", e);
                showToast("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê°€ìƒ ê²°ê³¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤. (CORS ë“±)", true);
                
                const winNumbers = new Set();
                while(winNumbers.size < 6) winNumbers.add(Math.floor(Math.random() * 45) + 1);
                const winArr = Array.from(winNumbers).sort((a,b)=>a-b);
                const bonus = Math.floor(Math.random() * 45) + 1;
                
                const year = drawDate.getFullYear();
                const month = String(drawDate.getMonth() + 1).padStart(2, '0');
                const day = String(drawDate.getDate()).padStart(2, '0');
                const simulatedDate = `${year}-${month}-${day} (ëª¨ì˜)`;

                const mockData = {
                    drwNo: round,
                    drwtNo1: winArr[0], drwtNo2: winArr[1], drwtNo3: winArr[2], 
                    drwtNo4: winArr[3], drwtNo5: winArr[4], drwtNo6: winArr[5],
                    bnusNo: bonus,
                    drwNoDate: simulatedDate
                };
                
                currentWinData = mockData;
                
                renderModalContent(mockData);
                checkWinningsInHistory(winArr, bonus, true);
            }
        }

        function checkWinningsInHistory(winArr, bonus, showMessage = true) {
            const items = document.querySelectorAll('.history-item');
            
            items.forEach(item => {
                if (!item.dataset.numbers) return;
                const myNumbers = JSON.parse(item.dataset.numbers);
                applyWinStyleToItem(item, winArr, bonus, myNumbers);
            });
            
            if(currentWinData) calculateAndShowSummary(currentWinData);
            if(showMessage) showToast("ê²°ê³¼ í™•ì¸ ì™„ë£Œ!");
        }

        function calculateAndShowSummary(winData) {
            const winArr = [
                winData.drwtNo1, winData.drwtNo2, winData.drwtNo3, 
                winData.drwtNo4, winData.drwtNo5, winData.drwtNo6
            ];
            const bonus = winData.bnusNo;
            
            let counts = { 1:0, 2:0, 3:0, 4:0, 5:0, fail:0 };
            let bestRank = 6;

            currentFilteredGames.forEach(game => {
                const nums = game.numbers;
                let matches = nums.filter(n => winArr.includes(n)).length;
                let bonusMatch = nums.includes(bonus);
                
                let rank = 6;
                if(matches === 6) rank = 1;
                else if(matches === 5 && bonusMatch) rank = 2;
                else if(matches === 5) rank = 3;
                else if(matches === 4) rank = 4;
                else if(matches === 3) rank = 5;
                
                if(rank < 6) counts[rank]++;
                else counts.fail++;

                if(rank < bestRank) bestRank = rank;
            });

            const totalWins = counts[1] + counts[2] + counts[3] + counts[4] + counts[5];
            displayGlobalResult(bestRank, totalWins, counts);
        }

        function displayGlobalResult(bestRank, totalWins, counts) {
            let title = "";
            let desc = "";
            let colorClass = "";

            if (bestRank === 1) {
                title = "ğŸ€ ëŒ€ë°•! 1ë“± ë‹¹ì²¨! ğŸ€";
                desc = "ì˜¤ëŠ˜ì´ ë°”ë¡œ ê·¸ë‚ ì…ë‹ˆë‹¤! ì¸ìƒ ì—­ì „ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!";
                colorClass = "text-yellow-600";
            } else if (bestRank === 2) {
                title = "ğŸ€ 2ë“± ë‹¹ì²¨! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ€";
                desc = "ì •ë§ ì•„ê¹ì§€ë§Œ ëŒ€ë‹¨í•œ ê²°ê³¼ì…ë‹ˆë‹¤! ì¶•í•˜ë“œë ¤ìš”!";
                colorClass = "text-gray-600";
            } else if (bestRank === 3) {
                title = "ğŸ€ 3ë“± ë‹¹ì²¨! ğŸ€";
                desc = "ìš´ì´ ì¢‹ìœ¼ì‹œë„¤ìš”! ë§›ìˆëŠ” ê±° ì‚¬ë“œì„¸ìš”.";
                colorClass = "text-orange-600";
            } else if (bestRank === 4) {
                title = "ğŸ€ 4ë“± ë‹¹ì²¨ ğŸ€";
                desc = "ì†Œì†Œí•œ í–‰ë³µ! 5ë§Œì› ì¶•í•˜ë“œë ¤ìš”.";
                colorClass = "text-blue-600";
            } else if (bestRank === 5) {
                title = "ğŸ€ 5ë“± ë‹¹ì²¨ ğŸ€";
                desc = "ë³¸ì „ì€ ì°¾ìœ¼ì…¨ë„¤ìš”! ë‹¤ìŒì„ ë…¸ë ¤ë³´ì„¸ìš”.";
                colorClass = "text-green-600";
            } else {
                title = "ê½.. ë‹¤ìŒ ê¸°íšŒì—.. ğŸ˜­";
                desc = "ì•„ì‰½ì§€ë§Œ ì´ë²ˆì—” ìš´ì´ ì—†ì—ˆë„¤ìš”. í˜ë‚´ì„¸ìš”!";
                colorClass = "text-gray-500";
            }
            
            if (totalWins > 0) {
                 let summary = `ì´ <b class="text-indigo-600">${totalWins}</b>ê±´ ë‹¹ì²¨! (`;
                 let details = [];
                 if(counts[1] > 0) details.push(`1ë“±:${counts[1]}ê±´`);
                 if(counts[2] > 0) details.push(`2ë“±:${counts[2]}ê±´`);
                 if(counts[3] > 0) details.push(`3ë“±:${counts[3]}ê±´`);
                 if(counts[4] > 0) details.push(`4ë“±:${counts[4]}ê±´`);
                 if(counts[5] > 0) details.push(`5ë“±:${counts[5]}ê±´`);
                 summary += details.join(', ') + ")";
                 
                 desc += `<br><span class="mt-1 block text-gray-600 text-xs">${summary}</span>`;
            }

            showGlobalResult(title, desc, colorClass);
        }

        function renderModalContent(data) {
            const numbers = [data.drwtNo1, data.drwtNo2, data.drwtNo3, data.drwtNo4, data.drwtNo5, data.drwtNo6];
            let ballsHtml = '<div class="flex justify-center gap-1 mb-4">';
            numbers.forEach(num => {
                ballsHtml += `<div class="lotto-ball small-ball ${getBallColorClass(num)}">${num}</div>`;
            });
            ballsHtml += '</div>';

            modalContent.innerHTML = `
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-2">${data.drwNoDate} ì¶”ì²¨</p>
                    <h4 class="text-2xl font-bold text-indigo-600 mb-4">ì œ ${data.drwNo}íšŒ</h4>
                    ${ballsHtml}
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <span class="text-gray-600 font-bold">ë³´ë„ˆìŠ¤</span>
                        <div class="lotto-ball small-ball ${getBallColorClass(data.bnusNo)}">${data.bnusNo}</div>
                    </div>
                </div>
            `;
        }

        function showModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                resultModal.classList.add('opacity-100');
                resultModal.querySelector('div').classList.remove('scale-95');
                resultModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            resultModal.classList.remove('opacity-100');
            resultModal.querySelector('div').classList.remove('scale-100');
            resultModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                resultModal.classList.add('hidden');
            }, 300);
        }

        resultModal.addEventListener('click', (e) => {
            if (e.target === resultModal) closeModal();
        });

        // Initialize App
        init();

    </script>
</body>
</html>

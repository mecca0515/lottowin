<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í–‰ìš´ì˜ ë¡œë˜ ë²ˆí˜¸ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- OCR Library (Tesseract.js) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1547545070-3602e2112613?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        .lotto-ball {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0.25rem;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        /* ì‘ì€ ë¡œë˜ ê³µ (ê¸°ë¡ìš©) - ì‚¬ì´ì¦ˆ í™•ëŒ€ */
        .small-ball {
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
            margin: 0.15rem;
            box-shadow: none;
            animation: none;
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s;
        }
        
        /* ë‹¹ì²¨ ë²ˆí˜¸ ê°•ì¡° íš¨ê³¼ */
        .small-ball.matched {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* ë‚™ì²¨ ë²ˆí˜¸ íšŒìƒ‰ ì²˜ë¦¬ */
        .small-ball.dimmed {
            background: #e5e7eb !important;
            background-image: none !important;
            color: #9ca3af !important;
            text-shadow: none !important;
            transform: scale(0.9);
            opacity: 0.7;
        }

        /* ìˆ˜ë™ ì…ë ¥ ëª¨ë‹¬ì˜ ì„ íƒëœ ê³µ */
        .select-ball {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f3f4f6;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }
        .select-ball:hover {
            background-color: #e5e7eb;
        }
        .select-ball.selected {
            border: 2px solid transparent;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .ball-yellow { background: linear-gradient(135deg, #fbc400, #ff9f00); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-blue { background: linear-gradient(135deg, #69c, #007bff); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-red { background: linear-gradient(135deg, #ff7272, #dc3545); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-gray { background: linear-gradient(135deg, #a5a5a5, #6c757d); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-green { background: linear-gradient(135deg, #b0d840, #28a745); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }

        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }

        .history-item {
            transition: all 0.2s;
            position: relative;
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .history-item:hover .delete-btn {
            opacity: 1;
        }

        #result-modal, #manual-input-modal, #delete-confirm-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        @media (max-width: 640px) {
            .lotto-ball { width: 2.5rem; height: 2.5rem; font-size: 1rem; }
            .small-ball { width: 1.5rem; height: 1.5rem; font-size: 0.75rem; }
            .select-ball { width: 2rem; height: 2rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="main-container max-w-md w-full rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-center shrink-0 flex flex-col items-center">
            <h1 class="text-2xl font-bold text-white mb-1">
                <i class="fas fa-clover mr-2"></i>ë¡œë˜ ë²ˆí˜¸ ìƒì„±ê¸°
            </h1>
            <p class="text-purple-100 text-sm mb-3">ì˜¤ëŠ˜ì˜ í–‰ìš´ì„ ì‹œí—˜í•´ë³´ì„¸ìš”!</p>
            
            <!-- Round Input + Date Display -->
            <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-3 py-1.5 shadow-inner transition-colors hover:bg-opacity-30 gap-2">
                <div class="flex items-center border-r border-white border-opacity-30 pr-2">
                    <span class="text-white text-xs mr-2 font-bold">íšŒì°¨ ì„ íƒ</span>
                    <input type="number" id="round-input" class="w-16 bg-transparent text-white text-right font-bold focus:outline-none text-sm border-b border-white border-opacity-50 appearance-none" value="">
                    <span class="text-white text-xs ml-1">íšŒ</span>
                </div>
                <!-- Draw Date Display -->
                <span id="draw-date" class="text-white text-xs opacity-90 font-medium"></span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-6 pb-2 shrink-0">
            <!-- Display Area: Can show Balls or Global Result Message -->
            <div id="numbers-container" class="flex flex-col justify-center items-center h-[120px] bg-white bg-opacity-50 rounded-xl p-4 mb-6 border border-gray-100 shadow-sm transition-all overflow-hidden relative">
                <!-- Default Placeholder or Balls -->
                <div id="generated-balls-area" class="flex flex-wrap justify-center items-center w-full h-full">
                    <span class="text-gray-500 text-sm">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</span>
                </div>
                
                <!-- Global Result Overlay (Initially Hidden) -->
                <div id="global-result-overlay" class="absolute inset-0 bg-white flex flex-col justify-center items-center hidden z-20">
                    <h2 id="global-rank-title" class="text-xl font-bold mb-1"></h2>
                    <p id="global-rank-desc" class="text-sm text-gray-500"></p>
                    <!-- êµ¬ë¶„ì„  -->
                    <hr class="w-16 border-gray-300 my-3">
                    <!-- ë‹«ê¸° ë²„íŠ¼: íŒ¨ë”©ì„ ì¤„ì—¬ì„œ ë” ë‚ ë µí•˜ê²Œ (py-1 px-4) -->
                    <button onclick="closeGlobalResult()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-1 px-4 rounded-md text-sm transition shadow-sm border border-gray-300">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex gap-2 mb-4">
                <button onclick="generateLotto()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-lg flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-sync-alt"></i> ë²ˆí˜¸ ìƒì„±
                </button>
                
                <!-- Image/QR Scan Button -->
                <button onclick="triggerImageUpload()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-lg flex items-center justify-center gap-2" title="ì´ë¯¸ì§€/QR ë²ˆí˜¸ ì¶”ì¶œ">
                    <i class="fas fa-camera"></i>
                </button>
                <input type="file" id="image-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">

                <!-- Manual Input Button -->
                <button onclick="openManualInput()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-lg flex items-center justify-center gap-2" title="ìˆ˜ë™ ì…ë ¥">
                    <i class="fas fa-hand-pointer"></i>
                </button>

                <button onclick="copyNumbers()" id="copy-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-bold py-3 px-3 rounded-xl transition duration-200 border border-gray-200 shadow-sm" title="í´ë¦½ë³´ë“œì— ë³µì‚¬">
                    <i class="far fa-copy"></i>
                </button>
            </div>
        </div>

        <!-- History (Fixed Height Area) -->
        <div class="px-6 pb-6 flex-1 flex flex-col">
            <div class="border-t border-gray-100 pt-4 flex flex-col h-full">
                <div class="flex justify-between items-center mb-3 shrink-0">
                    <h2 class="text-sm font-bold text-gray-600 uppercase tracking-wide">
                        <span id="history-round-label">í˜„ì¬</span> íšŒì°¨ ê¸°ë¡
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="fetchLatestResult()" class="text-xs text-blue-500 hover:text-blue-700 transition flex items-center gap-1 font-bold">
                            <i class="fas fa-trophy"></i> ê²°ê³¼ í™•ì¸
                        </button>
                        <button onclick="openDeleteConfirmModal()" class="text-xs text-red-400 hover:text-red-600 transition">ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>
                <!-- Fixed Height Container for History -->
                <div id="history-container" class="relative bg-white bg-opacity-30 rounded-lg border border-gray-100 p-2">
                    <!-- ë†’ì´ë¥¼ h-[28rem] (ì•½ 450px)ìœ¼ë¡œ ëŠ˜ë ¤ 5ê²Œì„ ì´ìƒ ë„‰ë„‰í•˜ê²Œ ë³´ì´ê²Œ ìˆ˜ì • -->
                    <div id="history-list" class="space-y-2 h-[28rem] overflow-y-auto custom-scrollbar pr-1">
                        <!-- History items will appear here -->
                        <div id="empty-history-msg" class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="fas fa-clipboard-list text-2xl mb-2 opacity-30"></i>
                            <span class="text-xs">ì•„ì§ ì´ íšŒì°¨ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                        </div>
                    </div>
                    
                    <!-- Loading Overlay for Image Scan -->
                    <div id="scan-loader" class="absolute inset-0 bg-white bg-opacity-95 z-10 hidden flex-col items-center justify-center rounded-lg">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-2"></div>
                        <span id="scan-message" class="text-xs text-indigo-600 font-bold">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
                        <span id="scan-sub-message" class="text-[10px] text-gray-400 mt-1">ìˆ«ìë§Œ ì§‘ì¤‘í•´ì„œ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-white bg-opacity-50 p-4 text-center text-xs text-gray-500 border-t border-gray-100 shrink-0">
            <p class="font-bold text-gray-600 mb-1">Good Luck! ğŸ€</p>
            <p class="text-[10px] text-gray-400 flex items-center justify-center gap-1">
                Created by 
                <a href="mailto:mecca0515@gmail.com" class="font-bold text-indigo-500 hover:text-indigo-700 flex items-center gap-1 transition" title="ì œì‘ìì—ê²Œ ë©”ì¼ ë³´ë‚´ê¸°">
                    mecca0515 <i class="fas fa-envelope text-[9px]"></i>
                </a>
                <span class="w-1 h-1 bg-gray-300 rounded-full mx-1"></span> 
                with <span class="font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Gemini</span> âœ¨
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-sm whitespace-nowrap">
        ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
    </div>

    <!-- Result Modal (Detailed Numbers) -->
    <div id="result-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">ë‹¹ì²¨ ê²°ê³¼ í™•ì¸</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-content" class="text-center">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <div id="manual-input-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-4 max-w-sm w-full mx-4 flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold text-gray-800">ë²ˆí˜¸ ì§ì ‘ ì…ë ¥</h3>
                <button onclick="closeManualInput()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="text-center mb-2 shrink-0">
                <span id="manual-count" class="text-sm font-bold text-indigo-600">0</span>
                <span class="text-sm text-gray-500">/ 6ê°œ ì„ íƒë¨</span>
            </div>

            <!-- Number Grid -->
            <div class="grid grid-cols-7 gap-2 overflow-y-auto p-1 custom-scrollbar flex-1 mb-4">
                <!-- JS will populate this -->
            </div>

            <div class="flex gap-2 shrink-0">
                <button onclick="resetManualSelection()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition text-sm">
                    ì´ˆê¸°í™”
                </button>
                <button onclick="saveManualInput()" id="manual-save-btn" class="flex-[2] bg-gray-300 text-white font-bold py-3 px-4 rounded-xl transition text-sm cursor-not-allowed" disabled>
                    ì…ë ¥ ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <!-- ì œëª©ì— ì´ëª¨í‹°ì½˜ ì¶”ê°€ -->
            <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ—‘ï¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</h3>
            <p class="text-gray-600 mb-6 text-sm">ì •ë§ ëª¨ë“  ë²ˆí˜¸ ìƒì„± ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteConfirmModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition text-sm">
                    ì·¨ì†Œ
                </button>
                <button onclick="confirmClearHistory()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition text-sm">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Canvas for Image Processing -->
    <canvas id="scan-canvas" class="hidden"></canvas>

    <script>
        let currentNumbers = [];
        let manualSelection = new Set();
        // State Management
        let historyData = []; // Array of objects {id, round, numbers, tag, date}
        let winResults = {}; // ë‹¹ì²¨ ê²°ê³¼ ìºì‹œ ì €ì¥ì†Œ (key: round, value: api data)
        let currentRound = 0;

        const historyList = document.getElementById('history-list');
        const emptyMsg = document.getElementById('empty-history-msg');
        const container = document.getElementById('numbers-container');
        const generatedBallsArea = document.getElementById('generated-balls-area');
        const globalResultOverlay = document.getElementById('global-result-overlay');
        const globalRankTitle = document.getElementById('global-rank-title');
        const globalRankDesc = document.getElementById('global-rank-desc');
        
        const resultModal = document.getElementById('result-modal');
        const manualInputModal = document.getElementById('manual-input-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const modalContent = document.getElementById('modal-content');
        const scanLoader = document.getElementById('scan-loader');
        const scanMessage = document.getElementById('scan-message');
        const scanSubMessage = document.getElementById('scan-sub-message');
        const roundInput = document.getElementById('round-input');
        const historyRoundLabel = document.getElementById('history-round-label');
        const drawDateSpan = document.getElementById('draw-date');

        // --- Initialization ---
        function init() {
            // Load history from local storage
            const storedHistory = localStorage.getItem('lotto_history');
            if (storedHistory) {
                historyData = JSON.parse(storedHistory);
            }

            // Load win results cache
            const storedWinResults = localStorage.getItem('lotto_win_results');
            if (storedWinResults) {
                winResults = JSON.parse(storedWinResults);
            }

            // Calculate or load current round
            const storedRound = localStorage.getItem('lotto_current_round');
            if (storedRound) {
                currentRound = parseInt(storedRound);
            } else {
                currentRound = calculateCurrentRound();
            }
            roundInput.value = currentRound;
            updateRoundInfo(currentRound);

            // Initial Render
            renderHistory(currentRound);
        }

        // íšŒì°¨ ìë™ ê³„ì‚° (2002-12-07 1íšŒì°¨ ê¸°ì¤€)
        function calculateCurrentRound() {
            const startDate = new Date('2002-12-07T00:00:00'); // 1íšŒì°¨
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return Math.floor(diffDays / 7) + 1;
        }

        // íšŒì°¨ì— ë”°ë¥¸ ì¶”ì²¨ ë‚ ì§œ ê³„ì‚° ë° í‘œì‹œ
        function updateRoundInfo(round) {
            historyRoundLabel.textContent = `${round}íšŒ`;
            
            // Calculate Draw Date (Saturday)
            const startDate = new Date('2002-12-07T00:00:00');
            const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
            
            const year = drawDate.getFullYear();
            const month = String(drawDate.getMonth() + 1).padStart(2, '0');
            const day = String(drawDate.getDate()).padStart(2, '0');
            
            drawDateSpan.textContent = `(${year}-${month}-${day})`;
        }

        // Round Input Listener
        roundInput.addEventListener('change', (e) => {
            let val = parseInt(e.target.value);
            if (!val || val < 1) val = 1;
            currentRound = val;
            roundInput.value = val;
            
            updateRoundInfo(val);
            
            // Save state and re-render
            localStorage.setItem('lotto_current_round', currentRound);
            renderHistory(currentRound);
            // Hide global result on round change
            closeGlobalResult();
        });

        // --- Data Management ---
        function addGameToData(numbers, tag) {
            const game = {
                id: Date.now() + Math.random(), // Unique ID
                round: currentRound,
                numbers: numbers,
                tag: tag,
                date: new Date().toISOString()
            };
            
            // Add to beginning of array
            historyData.unshift(game);
            saveHistory();
            
            // Render this item immediately at the top
            renderHistory(currentRound);
        }

        function deleteGameFromData(id) {
            historyData = historyData.filter(game => game.id !== id);
            saveHistory();
            renderHistory(currentRound);
        }

        function clearAllHistoryData() {
            historyData = [];
            saveHistory();
            renderHistory(currentRound);
        }

        function saveHistory() {
            localStorage.setItem('lotto_history', JSON.stringify(historyData));
        }

        // --- Rendering ---
        function renderHistory(round) {
            historyList.innerHTML = ''; // Clear list
            
            const filteredGames = historyData.filter(game => game.round === round);

            if (filteredGames.length === 0) {
                historyList.innerHTML = `
                    <div id="empty-history-msg" class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                        <i class="fas fa-clipboard-list text-2xl mb-2 opacity-30"></i>
                        <span class="text-xs">${round}íšŒì°¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                    </div>
                `;
                return;
            }

            filteredGames.forEach(game => {
                const item = createHistoryItemElement(game);
                historyList.appendChild(item);
            });

            // If we have cached results for this round, auto-check
            if (winResults[round]) {
                const data = winResults[round];
                const winArr = [
                    data.drwtNo1, data.drwtNo2, data.drwtNo3, 
                    data.drwtNo4, data.drwtNo5, data.drwtNo6
                ];
                // Delay slightly to ensure elements are ready
                setTimeout(() => {
                    checkWinningsInHistory(winArr, data.bnusNo, false); // false: Don't show toast on auto-check
                }, 100);
            }
        }

        function createHistoryItemElement(game) {
            const item = document.createElement('div');
            item.dataset.numbers = JSON.stringify(game.numbers); // For checking results later
            item.dataset.id = game.id;
            // Flex col to stack banner and content
            item.className = 'history-item bg-white bg-opacity-80 p-2 rounded-lg border border-gray-100 flex flex-col shadow-sm items-start';
            
            // Result Banner Removed (Moved to side of tag)

            // Content Wrapper (Row)
            const contentRow = document.createElement('div');
            contentRow.className = 'flex justify-between w-full items-center';

            const leftDiv = document.createElement('div');
            leftDiv.className = 'flex flex-col';

            // Balls Container: Added gap-1 for spacing
            const ballsContainer = document.createElement('div');
            ballsContainer.className = 'flex ball-container items-center gap-1';
            game.numbers.forEach(num => {
                const smallBall = document.createElement('div');
                smallBall.className = `lotto-ball small-ball ${getBallColorClass(num)}`;
                smallBall.textContent = num;
                smallBall.dataset.num = num;
                ballsContainer.appendChild(smallBall);
            });
            leftDiv.appendChild(ballsContainer);
            
            // Meta Info Container (Tags + Rank)
            const metaDiv = document.createElement('div');
            metaDiv.className = 'flex items-center mt-1 ml-1 meta-info';
            
            // Tags
            if (game.tag) {
                const tagSpan = document.createElement('span');
                let colorClass = 'text-gray-400';
                let icon = '';
                
                if (game.tag.includes('ìŠ¤ìº”') || game.tag.includes('ë¶„ì„') || game.tag.includes('Detect')) {
                    colorClass = 'text-teal-600';
                    icon = 'âš¡ ';
                } else if (game.tag.includes('ìˆ˜ë™')) {
                    colorClass = 'text-orange-500';
                    icon = 'ğŸ‘† ';
                }

                tagSpan.className = `text-[10px] font-bold ${colorClass}`;
                tagSpan.textContent = icon + game.tag;
                metaDiv.appendChild(tagSpan);
            }

            // Rank Badge Placeholder (Added here)
            const rankSpan = document.createElement('span');
            rankSpan.className = 'rank-badge text-[10px] font-bold ml-2 hidden'; // Hidden by default
            metaDiv.appendChild(rankSpan);

            leftDiv.appendChild(metaDiv);

            // Right side
            const rightDiv = document.createElement('div');
            rightDiv.className = 'flex flex-col items-end gap-1';

            // Parse date for display
            const dateObj = new Date(game.date);
            const timeStr = dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-400 whitespace-nowrap';
            timeSpan.textContent = timeStr;
            rightDiv.appendChild(timeSpan);

            // Delete Button
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn text-gray-400 hover:text-red-500 p-1';
            delBtn.innerHTML = '<i class="fas fa-trash-alt text-xs"></i>';
            delBtn.onclick = function() {
                deleteGameFromData(game.id);
            };
            rightDiv.appendChild(delBtn);

            contentRow.appendChild(leftDiv);
            contentRow.appendChild(rightDiv);
            item.appendChild(contentRow);
            
            return item;
        }

        // --- Core Functions ---
        function generateLotto() {
            closeGlobalResult(); // Hide previous result overlay if open
            const numbers = new Set();
            while (numbers.size < 6) {
                numbers.add(Math.floor(Math.random() * 45) + 1);
            }
            currentNumbers = Array.from(numbers).sort((a, b) => a - b);
            
            displayNumbers(currentNumbers);
            addGameToData(currentNumbers, "ìë™ ìƒì„±");
        }

        function getBallColorClass(num) {
            num = parseInt(num);
            if (num <= 10) return 'ball-yellow';
            if (num <= 20) return 'ball-blue';
            if (num <= 30) return 'ball-red';
            if (num <= 40) return 'ball-gray';
            return 'ball-green';
        }

        function displayNumbers(numbers) {
            generatedBallsArea.innerHTML = '';
            numbers.forEach((num, index) => {
                const ball = document.createElement('div');
                ball.className = `lotto-ball ${getBallColorClass(num)}`;
                ball.textContent = num;
                ball.style.animationDelay = `${index * 0.1}s`;
                generatedBallsArea.appendChild(ball);
            });
        }

        // Global Result Overlay
        function showGlobalResult(bestRankText, desc, colorClass) {
            globalRankTitle.textContent = bestRankText;
            globalRankTitle.className = `text-2xl font-bold mb-1 ${colorClass}`;
            globalRankDesc.textContent = desc;
            
            globalResultOverlay.classList.remove('hidden');
            // Simple pop-in effect
            globalResultOverlay.style.opacity = '0';
            setTimeout(() => {
                globalResultOverlay.style.transition = 'opacity 0.3s';
                globalResultOverlay.style.opacity = '1';
            }, 10);
        }

        function closeGlobalResult() {
            globalResultOverlay.classList.add('hidden');
        }

        /* --- Clear History Modal Logic --- */
        function openDeleteConfirmModal() {
            if (historyData.length === 0) {
                showToast("ì‚­ì œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            deleteConfirmModal.classList.remove('hidden');
            setTimeout(() => {
                deleteConfirmModal.classList.add('opacity-100');
                deleteConfirmModal.querySelector('div').classList.remove('scale-95');
                deleteConfirmModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.classList.remove('opacity-100');
            deleteConfirmModal.querySelector('div').classList.remove('scale-100');
            deleteConfirmModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                deleteConfirmModal.classList.add('hidden');
            }, 300);
        }

        function confirmClearHistory() {
            clearAllHistoryData();
            generatedBallsArea.innerHTML = '<span class="text-gray-500 text-sm">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</span>';
            currentNumbers = [];
            closeDeleteConfirmModal();
            showToast("ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function copyNumbers() {
            if (currentNumbers.length === 0) {
                showToast("ë¨¼ì € ë²ˆí˜¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
                return;
            }
            const textToCopy = currentNumbers.join(', ');
            
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast("ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + textToCopy);
            } catch (err) {
                showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
            document.body.removeChild(textArea);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            if (isError) {
                toast.classList.remove('bg-gray-800');
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.remove('bg-red-600');
                toast.classList.add('bg-gray-800');
            }
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2500);
        }

        /* --- Manual Input Logic --- */
        function openManualInput() {
            manualSelection = new Set();
            updateManualUI();
            
            const grid = manualInputModal.querySelector('.grid');
            grid.innerHTML = '';
            for(let i=1; i<=45; i++) {
                const btn = document.createElement('div');
                btn.className = 'select-ball';
                btn.textContent = i;
                btn.onclick = () => toggleManualNumber(i, btn);
                grid.appendChild(btn);
            }

            manualInputModal.classList.remove('hidden');
            setTimeout(() => {
                manualInputModal.classList.add('opacity-100');
                manualInputModal.querySelector('div').classList.remove('scale-95');
                manualInputModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function toggleManualNumber(num, btn) {
            if (manualSelection.has(num)) {
                manualSelection.delete(num);
                btn.classList.remove('selected');
                btn.style.background = '';
                btn.style.border = '';
            } else {
                if (manualSelection.size >= 6) {
                    showToast("6ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", true);
                    return;
                }
                manualSelection.add(num);
                btn.classList.add('selected');
                if (num <= 10) btn.style.background = '#fbc400';
                else if (num <= 20) btn.style.background = '#69c';
                else if (num <= 30) btn.style.background = '#ff7272';
                else if (num <= 40) btn.style.background = '#a5a5a5';
                else btn.style.background = '#b0d840';
                btn.style.borderColor = 'transparent';
            }
            updateManualUI();
        }

        function updateManualUI() {
            document.getElementById('manual-count').textContent = manualSelection.size;
            const saveBtn = document.getElementById('manual-save-btn');
            if (manualSelection.size === 6) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        function resetManualSelection() {
            manualSelection.clear();
            const btns = manualInputModal.querySelectorAll('.select-ball');
            btns.forEach(btn => {
                btn.classList.remove('selected');
                btn.style.background = '';
                btn.style.borderColor = '';
            });
            updateManualUI();
        }

        function saveManualInput() {
            if (manualSelection.size !== 6) return;
            currentNumbers = Array.from(manualSelection).sort((a, b) => a - b);
            displayNumbers(currentNumbers);
            // Replace addToHistory with addGameToData
            addGameToData(currentNumbers, "ìˆ˜ë™ ì…ë ¥");
            closeManualInput();
            showToast("ìˆ˜ë™ ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        function closeManualInput() {
            manualInputModal.classList.remove('opacity-100');
            manualInputModal.querySelector('div').classList.remove('scale-100');
            manualInputModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                manualInputModal.classList.add('hidden');
            }, 300);
        }

        /* --- Image/QR Scanning & OCR Logic --- */
        function triggerImageUpload() {
            document.getElementById('image-input').click();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            scanLoader.style.display = 'flex'; 
            scanMessage.textContent = "ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì¤‘...";
            scanSubMessage.textContent = "ê°€ë…ì„±ì„ ë†’ì´ê³  ìˆìŠµë‹ˆë‹¤";

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    processImage(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function processImage(img) {
            const canvas = document.getElementById('scan-canvas');
            const context = canvas.getContext('2d');
            
            const scaleFactor = 2; 
            canvas.width = img.width * scaleFactor;
            canvas.height = img.height * scaleFactor;
            context.scale(scaleFactor, scaleFactor);
            context.drawImage(img, 0, 0);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                const parsedGames = parseLottoQR(code.data);
                if (parsedGames && parsedGames.length > 0) {
                    finishScan(parsedGames, "QR ìŠ¤ìº”");
                    return;
                }
            }

            const d = imageData.data;
            for (let i = 0; i < d.length; i += 4) {
                const r = d[i];
                const g = d[i+1];
                const b = d[i+2];
                const v = 0.2126*r + 0.7152*g + 0.0722*b;
                d[i] = d[i+1] = d[i+2] = v;
            }
            context.putImageData(imageData, 0, 0);

            scanMessage.textContent = "ìˆ«ì ì •ë°€ ë¶„ì„ ì¤‘...";
            scanSubMessage.textContent = "2ë°° í™•ëŒ€í•˜ì—¬ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
            runOCR(canvas.toDataURL());
        }

        async function runOCR(imageSrc) {
            try {
                const worker = await Tesseract.createWorker('eng');
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDE0123456789\n ', 
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK, 
                });

                const { data: { text } } = await worker.recognize(imageSrc);
                const extractedGames = parseOCRText(text);
                
                if (extractedGames.length > 0) {
                    finishScan(extractedGames, "ì´ë¯¸ì§€ ë¶„ì„");
                } else {
                    scanLoader.style.display = 'none';
                    showToast("ìˆ«ìë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ì…ë ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”!", true);
                }
                await worker.terminate();
            } catch (err) {
                console.error(err);
                scanLoader.style.display = 'none';
                showToast("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
            }
        }

        function parseOCRText(text) {
            let games = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const matches = line.match(/\b\d{1,2}\b/g);
                if (!matches) return;
                
                const validNums = matches.map(n => parseInt(n)).filter(n => n >= 1 && n <= 45);
                const uniqueNums = [...new Set(validNums)];
                
                if (uniqueNums.length >= 6) {
                    const gameNums = uniqueNums.slice(0, 6).sort((a, b) => a - b);
                    let label = `Auto Detect ${games.length + 1}`;
                    const labelMatch = line.match(/[A-E]\b/); 
                    if (labelMatch) label = labelMatch[0];
                    
                    games.push({
                        label: label,
                        numbers: gameNums
                    });
                }
            });

            if (games.length === 0) {
                const allMatches = text.match(/\b\d{1,2}\b/g);
                if (allMatches) {
                    const allValidNums = allMatches.map(n => parseInt(n)).filter(n => n >= 1 && n <= 45);
                    let currentBuffer = [];
                    for (let i = 0; i < allValidNums.length; i++) {
                        const num = allValidNums[i];
                        if (!currentBuffer.includes(num)) currentBuffer.push(num);
                        if (currentBuffer.length === 6) {
                            games.push({
                                label: `Auto Detect ${games.length + 1}`,
                                numbers: [...currentBuffer].sort((a, b) => a - b)
                            });
                            currentBuffer = []; 
                        }
                    }
                }
            }
            return games;
        }

        function finishScan(games, method) {
            scanLoader.style.display = 'none';
            closeGlobalResult();
            
            if (games.length > 0) {
                currentNumbers = games[0].numbers;
                displayNumbers(currentNumbers);
            }
            for (let i = games.length - 1; i >= 0; i--) {
                const label = games[i].label.replace('Game ', '').replace('Auto Detect ', 'ìë™ '); 
                // Using data function
                addGameToData(games[i].numbers, `${method} ${label}`);
            }
            showToast(`${games.length}ê°œì˜ ê²Œì„ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤!`);
        }

        function parseLottoQR(url) {
            try {
                if (!url.includes('dhlottery.co.kr') || !url.includes('v=')) return null;
                let params = url.split('v=')[1];
                if (!params) return null;
                if (params.includes('&')) params = params.split('&')[0];
                const cleanStr = params.replace(/[^0-9]/g, '');
                if (cleanStr.length < 16) return null; 

                const numbersStr = cleanStr.substring(4);
                const games = [];
                const gameLabels = ['A', 'B', 'C', 'D', 'E'];
                
                for (let i = 0; i < numbersStr.length; i += 12) {
                    const chunk = numbersStr.substring(i, i + 12);
                    if (chunk.length < 12) break;
                    const nums = [];
                    for (let j = 0; j < 12; j += 2) nums.push(parseInt(chunk.substring(j, j + 2)));
                    if (nums.some(n => n < 1 || n > 45)) continue;
                    games.push({
                        label: gameLabels[games.length] || '?',
                        numbers: nums.sort((a, b) => a - b)
                    });
                    if (games.length >= 5) break; 
                }
                return games;
            } catch (e) { return null; }
        }

        /* --- Result & Checking Logic --- */
        async function fetchLatestResult() {
            const round = document.getElementById('round-input').value;
            
            // 1. ìºì‹œ í™•ì¸
            if (winResults[round]) {
                showModal();
                const cachedData = winResults[round];
                renderModalContent(cachedData);
                const winArr = [
                    cachedData.drwtNo1, cachedData.drwtNo2, cachedData.drwtNo3, 
                    cachedData.drwtNo4, cachedData.drwtNo5, cachedData.drwtNo6
                ];
                checkWinningsInHistory(winArr, cachedData.bnusNo, true); 
                return;
            }

            showModal();
            modalContent.innerHTML = `
                <div class="animate-pulse flex space-x-2 justify-center items-center h-16">
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                </div>
                <p class="text-gray-500 text-sm mt-2">${round}íšŒì°¨ ê²°ê³¼ í™•ì¸ ì¤‘...</p>
            `;

            // Future check
            const startDate = new Date('2002-12-07T00:00:00');
            const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
            drawDate.setHours(21, 0, 0, 0); // Approx draw time Sat 9PM
            const now = new Date();

            if (drawDate > now) {
                // Future round - show message and prevent fetch
                modalContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clock text-4xl text-gray-300 mb-2"></i>
                        <h4 class="text-lg font-bold text-gray-700">ì¶”ì²¨ ëŒ€ê¸° ì¤‘</h4>
                        <p class="text-gray-500 text-sm mt-1">${round}íšŒì°¨ ì¶”ì²¨ì¼ì€<br>${drawDate.toLocaleDateString()} ì…ë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            try {
                // 1. Proxy ì œê±° ë° ì§ì ‘ í˜¸ì¶œ (CORS issue may occur in some envs, fallback logic handles it)
                const timestamp = new Date().getTime();
                const targetUrl = `https://www.dhlottery.co.kr/lt645/selectPstLt645Info.do?srchLtEpsd=${round}&_=${timestamp}`;
                
                const response = await fetch(targetUrl);
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const jsonResponse = await response.json();

                // 2. ì‘ë‹µ êµ¬ì¡° íŒŒì‹± (data.list[0])
                if (jsonResponse.data && jsonResponse.data.list && jsonResponse.data.list.length > 0) {
                    const lottoData = jsonResponse.data.list[0];
                    
                    // ë‚ ì§œ í¬ë§· ë³€í™˜ (YYYYMMDD -> YYYY-MM-DD)
                    const dateStr = String(lottoData.ltRflYmd);
                    const formattedDate = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;

                    // ë‚´ë¶€ ë°ì´í„° í¬ë§·ìœ¼ë¡œ ë§¤í•‘
                    const mappedData = {
                        drwNo: lottoData.ltEpsd,
                        drwNoDate: formattedDate,
                        drwtNo1: lottoData.tm1WnNo,
                        drwtNo2: lottoData.tm2WnNo,
                        drwtNo3: lottoData.tm3WnNo,
                        drwtNo4: lottoData.tm4WnNo,
                        drwtNo5: lottoData.tm5WnNo,
                        drwtNo6: lottoData.tm6WnNo,
                        bnusNo: lottoData.bnsWnNo
                    };

                    // 3. ìºì‹œ ì €ì¥
                    winResults[round] = mappedData;
                    localStorage.setItem('lotto_win_results', JSON.stringify(winResults));

                    renderModalContent(mappedData);
                    
                    const winArr = [
                        mappedData.drwtNo1, mappedData.drwtNo2, mappedData.drwtNo3, 
                        mappedData.drwtNo4, mappedData.drwtNo5, mappedData.drwtNo6
                    ];
                    checkWinningsInHistory(winArr, mappedData.bnusNo, true);
                } else {
                    throw new Error('ì•„ì§ ì¶”ì²¨ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.warn("Lotto API Fetch Warning:", e);
                showToast("ì‹¤ì‹œê°„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê°€ìƒ ê²°ê³¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤. (CORS ì œí•œ)", true);
                
                // Fallback to mock data
                const winNumbers = new Set();
                while(winNumbers.size < 6) winNumbers.add(Math.floor(Math.random() * 45) + 1);
                const winArr = Array.from(winNumbers).sort((a,b)=>a-b);
                const bonus = Math.floor(Math.random() * 45) + 1;

                // Calculate date for fallback
                const startDate = new Date('2002-12-07T00:00:00');
                const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
                const year = drawDate.getFullYear();
                const month = String(drawDate.getMonth() + 1).padStart(2, '0');
                const day = String(drawDate.getDate()).padStart(2, '0');
                const simulatedDate = `${year}-${month}-${day} (ëª¨ì˜)`;

                const mockData = {
                    drwNo: round,
                    drwtNo1: winArr[0], drwtNo2: winArr[1], drwtNo3: winArr[2], 
                    drwtNo4: winArr[3], drwtNo5: winArr[4], drwtNo6: winArr[5],
                    bnusNo: bonus,
                    drwNoDate: simulatedDate
                };
                
                renderModalContent(mockData);
                checkWinningsInHistory(winArr, bonus, true);
            }
        }

        function checkWinningsInHistory(winArr, bonus, showMessage = true) {
            const items = document.querySelectorAll('.history-item');
            
            let bestRank = 6; // 6: ë‚™ì²¨, 5: 5ë“±, ... 1: 1ë“±
            
            items.forEach(item => {
                if (!item.dataset.numbers) return;
                
                const myNumbers = JSON.parse(item.dataset.numbers);
                
                let matchCount = 0;
                let isBonusMatched = false;
                
                const ballElements = item.querySelectorAll('.ball-container .lotto-ball');
                ballElements.forEach(ball => {
                    const num = parseInt(ball.dataset.num);
                    if (winArr.includes(num)) {
                        matchCount++;
                        ball.classList.add('matched');
                        ball.classList.remove('dimmed');
                    } else if (num === bonus) {
                        isBonusMatched = true;
                        // ë³´ë„ˆìŠ¤ ë§¤ì¹˜ ì²˜ë¦¬ (ìƒ‰ìƒ ìœ ì§€)
                        ball.classList.remove('dimmed');
                    } else {
                         // 3. í‹€ë¦° ë²ˆí˜¸ íšŒìƒ‰ ì²˜ë¦¬
                         ball.classList.remove('matched');
                         ball.classList.add('dimmed');
                    }
                });

                let rank = 0;
                let rankText = '';
                let rankClass = 'text-gray-400 pl-2 border-l border-gray-300'; // Default style

                // ë“±ìˆ˜ íŒë³„
                if (matchCount === 6) { 
                    rank = 1; 
                    rankText = 'ğŸ† 1ë“± ë‹¹ì²¨!';
                    rankClass = 'text-red-600 pl-2 border-l border-red-200';
                }
                else if (matchCount === 5 && isBonusMatched) { 
                    rank = 2; 
                    rankText = 'ğŸ¥ˆ 2ë“± ë‹¹ì²¨!';
                    rankClass = 'text-orange-600 pl-2 border-l border-orange-200';
                }
                else if (matchCount === 5) { 
                    rank = 3; 
                    rankText = 'ğŸ¥‰ 3ë“± ë‹¹ì²¨!';
                    rankClass = 'text-yellow-600 pl-2 border-l border-yellow-200';
                }
                else if (matchCount === 4) { 
                    rank = 4; 
                    rankText = '4ë“± (5ë§Œì›)';
                    rankClass = 'text-blue-600 pl-2 border-l border-blue-200';
                }
                else if (matchCount === 3) { 
                    rank = 5; 
                    rankText = '5ë“± (5ì²œì›)';
                    rankClass = 'text-green-600 pl-2 border-l border-green-200';
                }
                else { 
                    rank = 6; 
                    rankText = 'ë‚™ì²¨ (ë‹¤ìŒ ê¸°íšŒì—..)';
                    rankClass = 'text-gray-400 pl-2 border-l border-gray-300'; 
                }

                if (rank > 0 && rank < bestRank) bestRank = rank;

                // Update Rank Badge (New location next to tag)
                const rankBadge = item.querySelector('.rank-badge');
                if (rankBadge) {
                    rankBadge.textContent = rankText;
                    rankBadge.className = `rank-badge text-[10px] font-bold ml-2 ${rankClass}`;
                    rankBadge.classList.remove('hidden');
                }
            });
            
            // 2. ì „ì²´ ê²°ê³¼ í‘œì‹œ (ê°€ìš´ë° ì˜ì—­)
            displayGlobalResult(bestRank);
            if(showMessage) showToast("ê²°ê³¼ í™•ì¸ ì™„ë£Œ!");
        }

        function displayGlobalResult(bestRank) {
            let title = "";
            let desc = "";
            let colorClass = "";

            if (bestRank === 1) {
                title = "ğŸ’ğŸ‰ ëŒ€ë°•! 1ë“± ë‹¹ì²¨! ğŸ‰ğŸ’";
                desc = "ì˜¤ëŠ˜ì´ ë°”ë¡œ ê·¸ë‚ ì…ë‹ˆë‹¤! ì¸ìƒ ì—­ì „ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!";
                colorClass = "text-yellow-600";
            } else if (bestRank === 2) {
                title = "ğŸ’ğŸ¥ˆ 2ë“± ë‹¹ì²¨! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ’";
                desc = "ì •ë§ ì•„ê¹ì§€ë§Œ ëŒ€ë‹¨í•œ ê²°ê³¼ì…ë‹ˆë‹¤! ì¶•í•˜ë“œë ¤ìš”!";
                colorClass = "text-gray-600";
            } else if (bestRank === 3) {
                title = "ğŸ’ğŸ¥‰ 3ë“± ë‹¹ì²¨! ğŸ’";
                desc = "ìš´ì´ ì¢‹ìœ¼ì‹œë„¤ìš”! ë§›ìˆëŠ” ê±° ì‚¬ë“œì„¸ìš”.";
                colorClass = "text-orange-600";
            } else if (bestRank === 4) {
                title = "ğŸ’ 4ë“± ë‹¹ì²¨ ğŸ’";
                desc = "ì†Œì†Œí•œ í–‰ë³µ! 5ë§Œì› ì¶•í•˜ë“œë ¤ìš”.";
                colorClass = "text-blue-600";
            } else if (bestRank === 5) {
                title = "ğŸ’ 5ë“± ë‹¹ì²¨ ğŸ’";
                desc = "ë³¸ì „ì€ ì°¾ìœ¼ì…¨ë„¤ìš”! ë‹¤ìŒì„ ë…¸ë ¤ë³´ì„¸ìš”.";
                colorClass = "text-green-600";
            } else {
                title = "ê½.. ë‹¤ìŒ ê¸°íšŒì—.. ğŸ˜­";
                desc = "ì•„ì‰½ì§€ë§Œ ì´ë²ˆì—” ìš´ì´ ì—†ì—ˆë„¤ìš”. í˜ë‚´ì„¸ìš”!";
                colorClass = "text-gray-500";
            }

            showGlobalResult(title, desc, colorClass);
        }

        function renderModalContent(data) {
            const numbers = [data.drwtNo1, data.drwtNo2, data.drwtNo3, data.drwtNo4, data.drwtNo5, data.drwtNo6];
            let ballsHtml = '<div class="flex justify-center gap-1 mb-4">';
            numbers.forEach(num => {
                ballsHtml += `<div class="lotto-ball small-ball ${getBallColorClass(num)}">${num}</div>`;
            });
            ballsHtml += '</div>';

            modalContent.innerHTML = `
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-2">${data.drwNoDate} ì¶”ì²¨</p>
                    <h4 class="text-2xl font-bold text-indigo-600 mb-4">ì œ ${data.drwNo}íšŒ</h4>
                    ${ballsHtml}
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <span class="text-gray-600 font-bold">ë³´ë„ˆìŠ¤</span>
                        <div class="lotto-ball small-ball ${getBallColorClass(data.bnusNo)}">${data.bnusNo}</div>
                    </div>
                </div>
            `;
        }

        function showModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                resultModal.classList.add('opacity-100');
                resultModal.querySelector('div').classList.remove('scale-95');
                resultModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            resultModal.classList.remove('opacity-100');
            resultModal.querySelector('div').classList.remove('scale-100');
            resultModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                resultModal.classList.add('hidden');
            }, 300);
        }

        resultModal.addEventListener('click', (e) => {
            if (e.target === resultModal) closeModal();
        });

        // Initialize App
        init();

    </script>
</body>
</html>

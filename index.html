<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LottoWin - ë¶€ì ë˜ê¸° í”„ë¡œì íŠ¸</title>
    
    <!-- PWA Settings & App Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LottoWin">
    
    <!-- ì•„ì´ì½˜ ì„¤ì • -->
    <link rel="icon" type="image/png" href="app_logo.png">
    <link rel="apple-touch-icon" href="app_logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1547545070-3602e2112613?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        /* Splash Screen Animation */
        #splash-screen {
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #splash-screen.hidden-splash {
            opacity: 0;
            visibility: hidden;
        }

        /* Styles for balls */
        .lotto-ball {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0.25rem;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        .small-ball {
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
            margin: 0.15rem;
            box-shadow: none;
            animation: none;
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s;
        }
        
        .small-ball.matched {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .small-ball.bonus-matched {
            border: 2px solid #a855f7;
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
        }

        .small-ball.dimmed {
            background: #e5e7eb !important;
            background-image: none !important;
            color: #9ca3af !important;
            text-shadow: none !important;
            transform: scale(0.9);
            opacity: 0.7;
        }

        .select-ball {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f3f4f6;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }
        .select-ball:hover { background-color: #e5e7eb; }
        .select-ball.selected {
            border: 2px solid transparent;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .ball-yellow { background: linear-gradient(135deg, #fbc400, #ff9f00); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-blue { background: linear-gradient(135deg, #69c, #007bff); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-red { background: linear-gradient(135deg, #ff7272, #dc3545); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-gray { background: linear-gradient(135deg, #a5a5a5, #6c757d); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ball-green { background: linear-gradient(135deg, #b0d840, #28a745); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }

        @keyframes popIn { to { opacity: 1; transform: scale(1); } }

        .history-item { transition: all 0.2s; position: relative; }
        .history-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .delete-btn { opacity: 0.3; transition: opacity 0.2s; }
        .history-item:hover .delete-btn { opacity: 1; }

        .result-banner { transition: all 0.3s ease-out; max-height: 0; overflow: hidden; opacity: 0; }
        .result-banner.show { max-height: 200px; opacity: 1; margin-bottom: 0.25rem; padding: 0.25rem; }

        #result-modal, #manual-input-modal, #delete-confirm-modal, #settings-modal { background-color: rgba(0, 0, 0, 0.5); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        @keyframes float-badge {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-float-badge {
            animation: float-badge 2s ease-in-out infinite;
        }

        /* Toggle Switch CSS */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #e5e7eb; transition: all 0.3s; }
        .toggle-label { width: 2.5rem; height: 1.25rem; background-color: #d1d5db; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s; }
        .toggle-circle { position: absolute; top: 0.125rem; left: 0.125rem; width: 1rem; height: 1rem; background-color: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-checkbox:checked + .toggle-label .toggle-circle { transform: translateX(1.25rem); }

        @media (max-width: 640px) {
            .lotto-ball { width: 2.5rem; height: 2.5rem; font-size: 1rem; }
            .small-ball { width: 1.5rem; height: 1.5rem; font-size: 0.75rem; }
            .select-ball { width: 2rem; height: 2rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-gradient-to-br from-emerald-600 to-teal-800 flex flex-col items-center justify-center">
        <img src="app_logo.png" class="w-32 h-32 rounded-3xl shadow-2xl mb-6 animate-bounce object-cover" alt="LottoWin Logo">
        <h1 class="text-3xl font-bold text-white tracking-widest font-[Poppins]">LottoWin</h1>
        <p class="text-emerald-100 text-sm mt-2">ë¡œë˜ì˜ ê¿ˆì„ í˜„ì‹¤ë¡œ</p>
    </div>

    <div class="main-container max-w-md w-full rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 text-center shrink-0 flex flex-col items-center relative">
            <button onclick="openSettings()" class="absolute right-4 top-4 text-white text-opacity-80 hover:text-opacity-100 transition"><i class="fas fa-cog text-2xl"></i></button>
            
            <!-- Logo Area -->
            <div class="flex items-center justify-center gap-3 mb-2">
                <img src="app_logo.png" class="w-10 h-10 rounded-xl shadow-md border-2 border-emerald-400 object-cover" alt="Logo">
                <h1 class="text-2xl font-bold text-white tracking-tight" style="font-family: 'Poppins', sans-serif;">LottoWin</h1>
            </div>
            
            <p class="text-emerald-100 text-xs mb-3 italic">"ë‹¹ì‹ ì˜ í•˜ë£¨ì— í–‰ìš´ì´ ê¹ƒë“¤ê¸°ë¥¼ ë°”ëë‹ˆë‹¤"</p>
            
            <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-2 py-1 shadow-inner transition-colors hover:bg-opacity-30 gap-2">
                <div class="flex items-center border-r border-white border-opacity-30 pr-5 relative group cursor-pointer">
                    <span class="text-white text-xs mr-1 font-bold">íšŒì°¨ ì„ íƒ</span>
                    <div class="relative">
                        <select id="round-input" class="w-16 bg-transparent text-white text-right font-bold focus:outline-none text-xs appearance-none cursor-pointer pr-4 relative z-10 transform -translate-y-[1.5px]"></select>
                        <i class="fas fa-caret-down text-white text-[10px] absolute right-0 top-1/2 transform -translate-y-1/2 pointer-events-none opacity-70 group-hover:opacity-100"></i>
                    </div>
                    <span class="text-white text-xs ml-1">íšŒ</span>
                </div>
                <span id="draw-date" class="text-white text-xs opacity-90 font-medium"></span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-4 pb-2 shrink-0">
            <div id="numbers-container" class="flex flex-col justify-center items-center min-h-[130px] py-6 bg-white bg-opacity-50 rounded-xl px-2 mb-3 border border-gray-100 shadow-sm transition-all overflow-hidden relative">
                <div id="generated-balls-area" class="flex flex-wrap justify-center items-center w-full gap-2">
                    <span class="text-gray-500 text-xs">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</span>
                </div>
                <div id="global-result-overlay" class="absolute inset-0 bg-white flex flex-col justify-center items-center hidden z-20 pb-4">
                    <h2 id="global-rank-title" class="text-lg font-bold mb-1 mt-2"></h2>
                    <p id="global-rank-desc" class="text-xs text-gray-500 mb-4 text-center px-4"></p>
                    <button onclick="closeGlobalResult()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-1 px-4 rounded-md text-xs transition shadow-sm border border-gray-300">ë‹«ê¸°</button>
                </div>
                <div id="ai-loader" class="absolute inset-0 bg-white bg-opacity-95 z-20 hidden flex-col items-center justify-center">
                    <div class="w-10 h-10 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mb-3"></div>
                    <p class="text-emerald-600 font-bold text-sm">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p class="text-gray-400 text-xs mt-1">í–‰ìš´ì˜ íŒ¨í„´ì„ ì°¾ê³  ìˆì–´ìš” âœ¨</p>
                </div>
            </div>

            <!-- Buttons Area -->
            <div class="mb-4 flex gap-2">
                <button onclick="generateLottoAI()" class="flex-[3] bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-md flex items-center justify-center gap-2 text-base transform active:scale-95">
                    <i class="fas fa-magic"></i> AI ì¶”ì²œ
                </button>
                <button onclick="generatePatternLotto()" class="flex-[2] bg-white border-2 border-emerald-100 hover:border-emerald-300 text-emerald-700 font-bold py-3 px-4 rounded-xl transition duration-200 shadow-sm flex items-center justify-center gap-2 text-base transform active:scale-95">
                    <i class="fas fa-bolt"></i> íŒ¨í„´ ìƒì„±
                </button>
            </div>
            
            <div class="flex gap-2 mb-2 items-center">
                <button id="scan-btn" onclick="handleScanClick()" class="relative flex-1 bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-sm flex items-center justify-center gap-1.5 text-sm overflow-visible" title="ì´ë¯¸ì§€/QR ë²ˆí˜¸ ì¶”ì¶œ">
                    <i class="fas fa-camera"></i> <span>ìŠ¤ìº”</span>
                    <span id="key-badge" class="absolute -top-3 -right-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full shadow-md hidden animate-float-badge whitespace-nowrap z-10 border border-white">
                        API Key í•„ìš” ğŸ”’
                        <span class="absolute bottom-[-4px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-red-500"></span>
                    </span>
                </button>
                <input type="file" id="image-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                <button onclick="openManualInput()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-3 rounded-xl transition duration-200 transform active:scale-95 shadow-sm flex items-center justify-center gap-1.5 text-sm" title="ìˆ˜ë™ ì…ë ¥"><i class="fas fa-hand-pointer"></i> ìˆ˜ë™</button>
                <button onclick="copyNumbers()" id="copy-btn" class="w-12 h-12 bg-white hover:bg-gray-50 text-gray-700 font-bold rounded-full transition duration-200 border border-gray-200 shadow-sm flex items-center justify-center text-lg" title="í´ë¦½ë³´ë“œì— ë³µì‚¬"><i class="far fa-copy"></i></button>
            </div>
        </div>

        <!-- History -->
        <div class="px-4 pb-0 flex-1 flex flex-col">
            <div class="border-t border-gray-100 pt-2 flex flex-col h-full">
                <div class="flex justify-between items-center mb-2 shrink-0">
                    <h2 class="text-xs font-bold text-gray-600 uppercase tracking-wide flex items-center">
                        <span id="history-round-label">í˜„ì¬</span>ì°¨ ê¸°ë¡ <span id="total-count-badge" class="ml-1 text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full">(ì´ 0ê±´)</span>
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="fetchLatestResult()" class="text-xs text-blue-500 hover:text-blue-700 transition flex items-center gap-1 font-bold"><i class="fas fa-trophy"></i> ê²°ê³¼ í™•ì¸</button>
                        <span class="w-px h-3 bg-gray-300"></span>
                        <button onclick="openDeleteConfirmModal('ALL')" class="text-xs text-red-400 hover:text-red-600 transition">íšŒì°¨ ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>
                <div id="history-container" class="relative bg-white bg-opacity-30 rounded-lg border border-gray-100 p-1 mb-2">
                    <div id="history-list" class="space-y-1 h-96 overflow-y-auto custom-scrollbar pr-1">
                        <div id="empty-history-msg" class="flex flex-col items-center justify-center h-full text-gray-400"><i class="fas fa-clipboard-list text-2xl mb-2 opacity-30"></i><span class="text-xs">ì•„ì§ ì´ íšŒì°¨ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span></div>
                    </div>
                    <div id="scan-loader" class="absolute inset-0 bg-white bg-opacity-95 z-10 hidden flex-col items-center justify-center rounded-lg">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mb-2"></div>
                        <span id="scan-message" class="text-xs text-emerald-600 font-bold">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
                        <span id="scan-sub-message" class="text-[10px] text-gray-400 mt-1">ìˆ«ìë§Œ ì§‘ì¤‘í•´ì„œ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-white bg-opacity-50 p-2 text-center text-xs text-gray-500 border-t border-gray-100 shrink-0">
            <p class="font-bold text-gray-600 mb-1">Good Luck! ğŸ€</p>
            <p class="text-[10px] text-gray-400 flex items-center justify-center gap-1">Created by <a href="mailto:mecca0515@gmail.com" class="font-bold text-emerald-500 hover:text-emerald-700 flex items-center gap-1 transition">mecca0515 <i class="fas fa-envelope text-[9px]"></i></a> <span class="w-1 h-1 bg-gray-300 rounded-full mx-1"></span> with <span class="font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Gemini</span> âœ¨</p>
        </div>
    </div>

    <!-- PWA Install Floating Button -->
    <button id="pwa-install-btn" class="fixed bottom-6 right-6 bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-4 py-3 rounded-full shadow-xl z-50 hidden flex items-center gap-2 transition transform hover:scale-105 active:scale-95 font-bold border-2 border-white animate-bounce" onclick="installPWA()">
        <i class="fas fa-download"></i> <span>ì•± ì„¤ì¹˜</span>
    </button>

    <!-- Modals & Toasts -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-50 text-sm flex items-center gap-3 w-max max-w-[85vw] sm:max-w-md break-keep">
        <i class="fas fa-info-circle flex-shrink-0"></i> <span id="toast-msg" class="leading-snug">ë©”ì‹œì§€</span>
    </div>

    <div id="result-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">ë‹¹ì²¨ ê²°ê³¼ í™•ì¸</h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times"></i></button></div>
            <div id="modal-content" class="text-center"></div>
        </div>
    </div>

    <div id="manual-input-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-4 max-w-sm w-full mx-4 flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 shrink-0"><h3 class="text-lg font-bold text-gray-800">ë²ˆí˜¸ ì§ì ‘ ì…ë ¥</h3><button onclick="closeManualInput()" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times"></i></button></div>
            <div class="text-center mb-2 shrink-0"><span id="manual-count" class="text-sm font-bold text-indigo-600">0</span><span class="text-sm text-gray-500">/ 6ê°œ ì„ íƒë¨</span></div>
            <div class="grid grid-cols-7 gap-2 overflow-y-auto p-1 custom-scrollbar flex-1 mb-4"></div>
            <div class="flex gap-2 shrink-0"><button onclick="resetManualSelection()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition text-sm">ì´ˆê¸°í™”</button><button onclick="saveManualInput()" id="manual-save-btn" class="flex-[2] bg-gray-300 text-white font-bold py-3 px-4 rounded-xl transition text-sm cursor-not-allowed" disabled>ì…ë ¥ ì™„ë£Œ</button></div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <h3 id="delete-modal-title" class="text-lg font-bold text-gray-800 mb-2">ğŸ—‘ï¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</h3>
            <p id="delete-modal-desc" class="text-gray-600 mb-6 text-sm">ì •ë§ ëª¨ë“  ë²ˆí˜¸ ìƒì„± ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex gap-3"><button onclick="closeDeleteConfirmModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition text-sm">ì·¨ì†Œ</button><button onclick="confirmDelete()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition text-sm">ì‚­ì œ</button></div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">âš™ï¸ ì„¤ì •</h3><button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times"></i></button></div>
            
            <div class="mb-4 pb-4 border-b border-gray-100">
                <label class="block text-sm font-bold text-gray-700 mb-2">ê°œì¸ Gemini API í‚¤</label>
                <input type="password" id="user-api-key" placeholder="AIza..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                <p class="text-xs text-gray-500 mt-2">
                    * ì‹œìŠ¤í…œì„ ë¬´ë£Œë¡œ ê³„ì† ì‚¬ìš©í•˜ë ¤ë©´ Google AI Studioì—ì„œ ë¬´ë£Œ API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                    * í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline hover:text-indigo-800 ml-1">í‚¤ ë°œê¸‰ë°›ê¸°</a>
                </p>
            </div>

            <div class="mb-4 flex items-center justify-between">
                <div>
                    <label class="block text-sm font-bold text-gray-700">ë§¤ì£¼ í† ìš”ì¼ ì•Œë¦¼</label>
                    <p class="text-xs text-gray-500">ë°¤ 9ì‹œì— ì¶”ì²¨ ê²°ê³¼ í™•ì¸ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.</p>
                </div>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="notification-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer hidden" onchange="toggleNotification(this)"/>
                    <label for="notification-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer">
                        <span class="toggle-circle"></span>
                    </label>
                </div>
            </div>

            <button onclick="saveApiKey()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-xl transition">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <canvas id="scan-canvas" class="hidden"></canvas>

    <script>
        // --- Service Worker Registration for PWA ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW Registered'))
                    .catch(error => console.log('SW Registration failed', error));
            });
        }

        // --- Configuration ---
        const apiKey = ""; // System injected fallback key
        let userApiKey = localStorage.getItem('user_gemini_key') || "";
        let isNotificationEnabled = localStorage.getItem('lotto_noti_enabled') === 'true';

        // --- State ---
        let currentNumbers = [];
        let manualSelection = new Set();
        let historyData = []; 
        let winResults = {}; 
        let currentRound = 0;
        let deleteTargetId = null; 
        let displayedCount = 0;
        const PAGE_SIZE = 20;
        let currentFilteredGames = [];
        let currentWinData = null; 
        let toastTimeoutId = null;

        // --- Elements ---
        const historyList = document.getElementById('history-list');
        const emptyMsg = document.getElementById('empty-history-msg');
        const container = document.getElementById('numbers-container');
        const generatedBallsArea = document.getElementById('generated-balls-area');
        const globalResultOverlay = document.getElementById('global-result-overlay');
        const globalRankTitle = document.getElementById('global-rank-title');
        const globalRankDesc = document.getElementById('global-rank-desc');
        const totalCountBadge = document.getElementById('total-count-badge');
        const resultModal = document.getElementById('result-modal');
        const manualInputModal = document.getElementById('manual-input-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalDesc = document.getElementById('delete-modal-desc');
        const modalContent = document.getElementById('modal-content');
        const scanLoader = document.getElementById('scan-loader');
        const scanMessage = document.getElementById('scan-message');
        const scanSubMessage = document.getElementById('scan-sub-message');
        const roundInput = document.getElementById('round-input');
        const historyRoundLabel = document.getElementById('history-round-label');
        const drawDateSpan = document.getElementById('draw-date');
        const settingsModal = document.getElementById('settings-modal');
        const userApiKeyInput = document.getElementById('user-api-key');
        const notificationToggle = document.getElementById('notification-toggle');
        const aiLoader = document.getElementById('ai-loader');
        const scanBtn = document.getElementById('scan-btn');

        function init() {
            const storedHistory = localStorage.getItem('lotto_history');
            if (storedHistory) { historyData = JSON.parse(storedHistory); }
            const storedWinResults = localStorage.getItem('lotto_win_results');
            if (storedWinResults) { winResults = JSON.parse(storedWinResults); }

            const latestRound = calculateCurrentRound();
            populateRoundSelect(latestRound); 

            const storedRound = localStorage.getItem('lotto_current_round');
            if (storedRound) {
                currentRound = parseInt(storedRound);
                if(currentRound > latestRound) currentRound = latestRound;
            } else {
                currentRound = latestRound; 
            }
            roundInput.value = currentRound;
            updateRoundInfo(currentRound);
            renderHistory(currentRound);
            historyList.addEventListener('scroll', () => {
                if (historyList.scrollTop + historyList.clientHeight >= historyList.scrollHeight - 50) {
                    loadMoreHistory();
                }
            });

            if (userApiKey) { userApiKeyInput.value = userApiKey; }
            notificationToggle.checked = isNotificationEnabled;
            if (isNotificationEnabled) { startNotificationScheduler(); }
            updateScanButtonState();
            
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if(splash) {
                    splash.style.opacity = '0';
                    setTimeout(() => splash.remove(), 500);
                }
            }, 1500);
        }

        // ... [Basic Calculation & UI Functions] ...
        function calculateCurrentRound() {
            const startDate = new Date('2002-12-07T00:00:00'); 
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return Math.floor((diffDays - 1) / 7) + 2;
        }

        function populateRoundSelect(maxRound) {
            roundInput.innerHTML = '';
            for (let i = maxRound; i >= 1; i--) {
                const option = document.createElement('option');
                option.value = i; option.textContent = i; option.className = "text-gray-800";
                roundInput.appendChild(option);
            }
        }

        function updateRoundInfo(round) {
            historyRoundLabel.textContent = `${round}íšŒ`;
            const startDate = new Date('2002-12-07T00:00:00');
            const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
            const year = drawDate.getFullYear(); const month = String(drawDate.getMonth() + 1).padStart(2, '0'); const day = String(drawDate.getDate()).padStart(2, '0');
            drawDateSpan.textContent = `(${year}-${month}-${day})`;
        }

        roundInput.addEventListener('change', (e) => {
            let val = parseInt(e.target.value); currentRound = val; updateRoundInfo(val);
            localStorage.setItem('lotto_current_round', currentRound); renderHistory(currentRound); closeGlobalResult();
        });

        function addGameToData(numbers, tag) {
            const game = { id: Date.now() + Math.random(), round: currentRound, numbers: numbers, tag: tag, date: new Date().toISOString() };
            historyData.unshift(game); saveHistory(); renderHistory(currentRound);
        }

        function deleteGameFromData(id) {
            historyData = historyData.filter(game => game.id !== id); saveHistory(); renderHistory(currentRound);
        }

        function clearCurrentRoundHistory() {
            historyData = historyData.filter(game => game.round !== currentRound); saveHistory(); renderHistory(currentRound);
        }

        function saveHistory() {
            localStorage.setItem('lotto_history', JSON.stringify(historyData));
        }

        // --- Core: Pattern Generation Logic ---
        function generatePatternLotto() {
            closeGlobalResult();
            const patternData = applyRandomPattern();
            currentNumbers = patternData.numbers;
            displayNumbers(currentNumbers);
            addGameToData(currentNumbers, patternData.name);
            showToast(`íŒ¨í„´ ì ìš©: ${patternData.name}`);
        }

        function applyRandomPattern() {
            const patterns = [
                { name: "âš¡ 20ë²ˆëŒ€ ì§‘ì¤‘", weight: 1, func: () => generateDecadeFocus(21, 30, 3) },
                { name: "âš¡ 10&30ë²ˆëŒ€ ë¯¹ìŠ¤", weight: 1, func: () => generateMixedDecades(11, 20, 2, 31, 40, 2) },
                { name: "âš¡ 40ë²ˆëŒ€ ì—°ë²ˆ", weight: 1, func: () => generateConsecutiveInRange(41, 45) },
                { name: "âš¡ ì—°ë²ˆ í¬í•¨", weight: 1, func: () => generateConsecutiveAny() },
                { name: "âš¡ ëìˆ˜ ì¼ì¹˜", weight: 1, func: () => generateEndingMatch() },
                { name: "ğŸ² ëœë¤ ìƒì„±", weight: 2, func: () => generateRandomFixed(6) },
                { name: "âš¡ 10ë²ˆëŒ€ ì§‘ì¤‘", weight: 1, func: () => generateDecadeFocus(11, 20, 3) },
                { name: "âš¡ 30ë²ˆëŒ€ ì§‘ì¤‘", weight: 1, func: () => generateDecadeFocus(31, 40, 3) },
                { name: "âš¡ 20~30ë²ˆëŒ€ ì§‘ì¤‘", weight: 1, func: () => generateDecadeFocus(21, 40, 4) }, // 20~40 ì‚¬ì´ì—ì„œ 4ê°œ
                { name: "âš–ï¸ ì €ê³ (Low/High) ê· í˜•", weight: 1, func: () => generateLowHighMix() },
                { name: "ğŸŒˆ ê³¨ê³ ë£¨ ë¶„í¬", weight: 1, func: () => generateBalanced() }
            ];
            
            const strategy = patterns[Math.floor(Math.random() * patterns.length)];
            let nums = strategy.func();
            
            if (!nums || nums.length !== 6 || new Set(nums).size !== 6) {
                return { numbers: generateRandomFixed(6), name: "ğŸ² ëœë¤ ìƒì„± (Fallback)" };
            }
            return { numbers: nums.sort((a,b)=>a-b), name: strategy.name };
        }

        // Helpers for Patterns
        function generateRandomFixed(count, exclude = []) {
            const nums = new Set();
            while(nums.size < count) {
                let n = Math.floor(Math.random() * 45) + 1;
                if (!exclude.includes(n)) nums.add(n);
            }
            return Array.from(nums);
        }

        function generateDecadeFocus(start, end, count) {
            const focusNums = new Set();
            while(focusNums.size < count) {
                let n = Math.floor(Math.random() * (end - start + 1)) + start;
                focusNums.add(n);
            }
            const remainder = generateRandomFixed(6 - count, Array.from(focusNums));
            return [...focusNums, ...remainder];
        }

        function generateMixedDecades(s1, e1, c1, s2, e2, c2) {
            const set1 = new Set();
            while(set1.size < c1) set1.add(Math.floor(Math.random() * (e1 - s1 + 1)) + s1);
            const set2 = new Set();
            while(set2.size < c2) set2.add(Math.floor(Math.random() * (e2 - s2 + 1)) + s2);
            
            const used = [...set1, ...set2];
            const remainder = generateRandomFixed(6 - c1 - c2, used);
            return [...used, ...remainder];
        }

        function generateConsecutiveInRange(start, end) {
            let n = Math.floor(Math.random() * (end - start)) + start; 
            const seed = [n, n+1];
            const remainder = generateRandomFixed(4, seed);
            return [...seed, ...remainder];
        }

        function generateConsecutiveAny() {
            let n = Math.floor(Math.random() * 44) + 1; 
            const seed = [n, n+1];
            const remainder = generateRandomFixed(4, seed);
            return [...seed, ...remainder];
        }

        function generateEndingMatch() {
            const digit = Math.floor(Math.random() * 10);
            const candidates = [digit, digit+10, digit+20, digit+30, digit+40].filter(n => n >= 1 && n <= 45);
            if (candidates.length < 2) return generateRandomFixed(6); 
            
            const shuffled = candidates.sort(() => 0.5 - Math.random());
            const seed = shuffled.slice(0, 2);
            const remainder = generateRandomFixed(4, seed);
            return [...seed, ...remainder];
        }

        function generateLowHighMix() {
            // Low: 1~23, High: 24~45 (Rough split)
            const lowSet = new Set();
            while(lowSet.size < 3) lowSet.add(Math.floor(Math.random() * 23) + 1);
            
            const highSet = new Set();
            while(highSet.size < 3) highSet.add(Math.floor(Math.random() * (45 - 24 + 1)) + 24);
            
            return [...lowSet, ...highSet];
        }

        function generateBalanced() {
            // Try to pick at least one from 1-10, 11-20, 21-30, 31-40, 41-45
            const ranges = [
                {s: 1, e: 10}, {s: 11, e: 20}, {s: 21, e: 30}, {s: 31, e: 40}, {s: 41, e: 45}
            ];
            const nums = new Set();
            
            // Pick 1 from each range
            ranges.forEach(r => {
                const n = Math.floor(Math.random() * (r.e - r.s + 1)) + r.s;
                nums.add(n);
            });
            
            // Pick last one freely
            while(nums.size < 6) {
                nums.add(Math.floor(Math.random() * 45) + 1);
            }
            
            return Array.from(nums);
        }

        // --- AI Logic ---
        async function generateLottoAI() {
            closeGlobalResult();
            const keyToUse = userApiKey || apiKey;
            if (!keyToUse) {
                generatePatternLotto();
                showToast("AIê°€ ì˜ê°ì„ ë°›ëŠ” ì¤‘ ì ë“¤ì—ˆë„¤ìš” ğŸ˜´ ëŒ€ì‹  í–‰ìš´ì˜ íŒ¨í„´ ë²ˆí˜¸ë¥¼ ë“œë ¤ìš”!");
                return;
            }

            aiLoader.style.display = 'flex';
            generatedBallsArea.innerHTML = '';
            
            try {
                const seed = Date.now();
                const prompt = `Act as a complex lottery number generator algorithm.
Generate 6 unique numbers between 1 and 45 based on a complex, non-repetitive statistical model.
Avoid simple patterns like multiples of 7 or sequential numbers unless statistically significant.
Ensure a balanced distribution of decades (10s, 20s, 30s, 40s).
Current Random Seed: ${seed}
Provide a creative, data-driven reason for this combination in Korean (e.g., "í‘œì¤€ í¸ì°¨ ë¶„ì„ ê²°ê³¼...", "íšŒê·€ ë¶„ì„ ëª¨ë¸ì— ë”°ë¥¸...").
Output ONLY a valid JSON object: { "numbers": [1, 2, 3, 4, 5, 6], "reason": "ì´ìœ " }`;
                
                const responseText = await callGeminiTextAPI(prompt);
                
                let result;
                try {
                    const cleanText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                    result = JSON.parse(cleanText);
                } catch (e) {
                    throw new Error("AI ì‘ë‹µ í•´ì„ ì‹¤íŒ¨");
                }

                if (!result.numbers || result.numbers.length !== 6) throw new Error("ë²ˆí˜¸ ìƒì„± ì˜¤ë¥˜");

                currentNumbers = result.numbers.sort((a, b) => a - b);
                displayNumbers(currentNumbers);
                addGameToData(currentNumbers, "AI ì¶”ì²œ");
                if (result.reason) showToast("âœ¨ AI: " + result.reason);

            } catch (err) {
                console.error(err);
                generatePatternLotto();
                showToast("AIê°€ ì˜ê°ì„ ë°›ëŠ” ì¤‘ ì ë“¤ì—ˆë„¤ìš” ğŸ˜´ ëŒ€ì‹  í–‰ìš´ì˜ ëœë¤ ë²ˆí˜¸ë¥¼ ë“œë ¤ìš”!");
            } finally {
                aiLoader.style.display = 'none';
            }
        }

        async function callGeminiTextAPI(prompt) {
             const keyToUse = userApiKey || apiKey;
             if (!keyToUse) throw new Error("Missing API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.9,
                    topK: 40,
                    topP: 0.95
                }
            };

            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Gemini API Error: ${response.status}`);
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // --- Standard UI Functions ---
        function renderHistory(round) {
            historyList.innerHTML = ''; 
            displayedCount = 0;
            currentWinData = winResults[round] || null; 
            currentFilteredGames = historyData.filter(game => game.round === round);
            totalCountBadge.textContent = `(ì´ ${currentFilteredGames.length}ê±´)`;

            if (currentFilteredGames.length === 0) {
                historyList.innerHTML = `<div id="empty-history-msg" class="flex flex-col items-center justify-center h-full text-gray-400 py-10"><i class="fas fa-clipboard-list text-2xl mb-2 opacity-30"></i><span class="text-xs">${round}íšŒì°¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span></div>`;
                return;
            }
            loadMoreHistory();
            if (currentWinData) { calculateAndShowSummary(currentWinData); }
        }

        function loadMoreHistory() {
            const nextBatch = currentFilteredGames.slice(displayedCount, displayedCount + PAGE_SIZE);
            if(nextBatch.length === 0) return;
            const fragment = document.createDocumentFragment();
            nextBatch.forEach(game => {
                const item = createHistoryItemElement(game);
                if(currentWinData) {
                    const winArr = [currentWinData.drwtNo1, currentWinData.drwtNo2, currentWinData.drwtNo3, currentWinData.drwtNo4, currentWinData.drwtNo5, currentWinData.drwtNo6];
                    applyWinStyleToItem(item, winArr, currentWinData.bnusNo, game.numbers);
                }
                fragment.appendChild(item);
            });
            historyList.appendChild(fragment);
            displayedCount += nextBatch.length;
        }

        function applyWinStyleToItem(item, winArr, bonus, myNumbers) {
            let matchCount = 0; let isBonusMatched = false;
            myNumbers.forEach(num => { if (winArr.includes(num)) matchCount++; else if (num === bonus) isBonusMatched = true; });
            let rank = 6;
            if (matchCount === 6) rank = 1; else if (matchCount === 5 && isBonusMatched) rank = 2; else if (matchCount === 5) rank = 3; else if (matchCount === 4) rank = 4; else if (matchCount === 3) rank = 5;

            const ballElements = item.querySelectorAll('.ball-container .lotto-ball');
            ballElements.forEach(ball => {
                const num = parseInt(ball.dataset.num);
                if (winArr.includes(num)) { ball.classList.add('matched'); ball.classList.remove('dimmed'); }
                else if (num === bonus) {
                    if (rank === 2) { ball.classList.add('bonus-matched'); ball.classList.remove('dimmed'); }
                    else { ball.classList.remove('matched'); ball.classList.remove('bonus-matched'); ball.classList.add('dimmed'); }
                } else { ball.classList.remove('matched'); ball.classList.remove('bonus-matched'); ball.classList.add('dimmed'); }
            });

            const rankBadge = item.querySelector('.rank-badge');
            if (rankBadge) {
                let rankText = ''; let rankClass = 'text-gray-400 pl-2 border-l border-gray-300'; 
                if (rank === 1) { rankText = 'ğŸ† 1ë“± ë‹¹ì²¨!'; rankClass = 'text-red-600 pl-2 border-l border-red-200'; }
                else if (rank === 2) { rankText = 'ğŸ¥ˆ 2ë“± ë‹¹ì²¨!'; rankClass = 'text-orange-600 pl-2 border-l border-orange-200'; }
                else if (rank === 3) { rankText = 'ğŸ¥‰ 3ë“± ë‹¹ì²¨!'; rankClass = 'text-yellow-600 pl-2 border-l border-yellow-200'; }
                else if (rank === 4) { rankText = '4ë“± (5ë§Œì›)'; rankClass = 'text-blue-600 pl-2 border-l border-blue-200'; }
                else if (rank === 5) { rankText = '5ë“± (5ì²œì›)'; rankClass = 'text-green-600 pl-2 border-l border-green-200'; }
                else { rankText = 'ë‚™ì²¨'; rankClass = 'text-gray-400 pl-2 border-l border-gray-300'; }
                
                rankBadge.textContent = rankText; rankBadge.className = `rank-badge text-[10px] font-bold ml-2 ${rankClass}`; rankBadge.classList.remove('hidden');
            }
        }

        function calculateAndShowSummary(winData) {
            const winArr = [winData.drwtNo1, winData.drwtNo2, winData.drwtNo3, winData.drwtNo4, winData.drwtNo5, winData.drwtNo6];
            const bonus = winData.bnusNo;
            let counts = { 1:0, 2:0, 3:0, 4:0, 5:0, fail:0 }; let bestRank = 6;
            currentFilteredGames.forEach(game => {
                const nums = game.numbers; let matches = nums.filter(n => winArr.includes(n)).length; let bonusMatch = nums.includes(bonus); let rank = 6;
                if(matches === 6) rank = 1; else if(matches === 5 && bonusMatch) rank = 2; else if(matches === 5) rank = 3; else if(matches === 4) rank = 4; else if(matches === 3) rank = 5;
                if(rank < 6) counts[rank]++; else counts.fail++; if(rank < bestRank) bestRank = rank;
            });
            const totalWins = counts[1] + counts[2] + counts[3] + counts[4] + counts[5]; displayGlobalResult(bestRank, totalWins, counts);
        }

        function displayGlobalResult(bestRank, totalWins, counts) {
            let title = "", desc = "", colorClass = "";
            if (bestRank === 1) { title = "ğŸ€ ëŒ€ë°•! 1ë“± ë‹¹ì²¨! ğŸ€"; desc = "ì˜¤ëŠ˜ì´ ë°”ë¡œ ê·¸ë‚ ì…ë‹ˆë‹¤! ì¸ìƒ ì—­ì „ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!"; colorClass = "text-yellow-600"; }
            else if (bestRank === 2) { title = "ğŸ€ 2ë“± ë‹¹ì²¨! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ€"; desc = "ì •ë§ ì•„ê¹ì§€ë§Œ ëŒ€ë‹¨í•œ ê²°ê³¼ì…ë‹ˆë‹¤! ì¶•í•˜ë“œë ¤ìš”!"; colorClass = "text-gray-600"; }
            else if (bestRank === 3) { title = "ğŸ€ 3ë“± ë‹¹ì²¨! ğŸ€"; desc = "ìš´ì´ ì¢‹ìœ¼ì‹œë„¤ìš”! ë§›ìˆëŠ” ê±° ì‚¬ë“œì„¸ìš”."; colorClass = "text-orange-600"; }
            else if (bestRank === 4) { title = "ğŸ€ 4ë“± ë‹¹ì²¨ ğŸ€"; desc = "ì†Œì†Œí•œ í–‰ë³µ! 5ë§Œì› ì¶•í•˜ë“œë ¤ìš”."; colorClass = "text-blue-600"; }
            else if (bestRank === 5) { title = "ğŸ€ 5ë“± ë‹¹ì²¨ ğŸ€"; desc = "ë³¸ì „ì€ ì°¾ìœ¼ì…¨ë„¤ìš”! ë‹¤ìŒì„ ë…¸ë ¤ë³´ì„¸ìš”."; colorClass = "text-green-600"; }
            else { title = "ê½.. ë‹¤ìŒ ê¸°íšŒì—.. ğŸ˜­"; desc = "ì•„ì‰½ì§€ë§Œ ì´ë²ˆì—” ìš´ì´ ì—†ì—ˆë„¤ìš”. í˜ë‚´ì„¸ìš”!"; colorClass = "text-gray-500"; }
            if (totalWins > 0) {
                 let summary = `ì´ <b class="text-indigo-600">${totalWins}</b>ê±´ ë‹¹ì²¨! (`;
                 let details = []; if(counts[1] > 0) details.push(`1ë“±:${counts[1]}ê±´`); if(counts[2] > 0) details.push(`2ë“±:${counts[2]}ê±´`); if(counts[3] > 0) details.push(`3ë“±:${counts[3]}ê±´`); if(counts[4] > 0) details.push(`4ë“±:${counts[4]}ê±´`); if(counts[5] > 0) details.push(`5ë“±:${counts[5]}ê±´`);
                 summary += details.join(', ') + ")"; desc += `<br><span class="mt-1 block text-gray-600 text-xs">${summary}</span>`;
            } showGlobalResult(title, desc, colorClass);
        }

        function createHistoryItemElement(game) {
            const item = document.createElement('div');
            item.dataset.numbers = JSON.stringify(game.numbers); item.dataset.id = game.id;
            item.className = 'history-item bg-white bg-opacity-80 p-2 rounded-lg border border-gray-100 flex flex-col shadow-sm items-start';
            const contentRow = document.createElement('div'); contentRow.className = 'flex justify-between w-full items-center';
            const leftDiv = document.createElement('div'); leftDiv.className = 'flex flex-col';
            const ballsContainer = document.createElement('div'); ballsContainer.className = 'flex ball-container items-center gap-1';
            game.numbers.forEach(num => {
                const smallBall = document.createElement('div'); smallBall.className = `lotto-ball small-ball ${getBallColorClass(num)}`; smallBall.textContent = num; smallBall.dataset.num = num; ballsContainer.appendChild(smallBall);
            });
            leftDiv.appendChild(ballsContainer);
            
            if (game.tag) {
                const metaDiv = document.createElement('div'); metaDiv.className = 'flex items-center mt-1 ml-1 meta-info';
                const tagSpan = document.createElement('span');
                let colorClass = 'text-gray-400', icon = '';
                if (game.tag.includes('ìŠ¤ìº”') || game.tag.includes('ë¶„ì„')) { colorClass = 'text-teal-600'; icon = 'âš¡ '; }
                else if (game.tag.includes('ìˆ˜ë™')) { colorClass = 'text-orange-500'; icon = 'ğŸ‘† '; }
                else if (game.tag.includes('AI')) { colorClass = 'text-purple-600'; icon = 'âœ¨ '; }
                else if (game.tag.includes('ëœë¤') || game.tag.includes('íŒ¨í„´')) { colorClass = 'text-blue-500'; icon = 'âš¡ '; }
                tagSpan.className = `text-[10px] font-bold ${colorClass}`; tagSpan.textContent = icon + game.tag;
                metaDiv.appendChild(tagSpan);
                const rankSpan = document.createElement('span'); rankSpan.className = 'rank-badge text-[10px] font-bold ml-2 hidden'; 
                metaDiv.appendChild(rankSpan); leftDiv.appendChild(metaDiv);
            }
            const rightDiv = document.createElement('div'); rightDiv.className = 'flex flex-col items-end gap-1';
            const dateObj = new Date(game.date); const timeStr = dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            const timeSpan = document.createElement('span'); timeSpan.className = 'text-xs text-gray-400 whitespace-nowrap'; timeSpan.textContent = timeStr;
            rightDiv.appendChild(timeSpan);
            const delBtn = document.createElement('button'); delBtn.className = 'delete-btn text-gray-400 hover:text-red-500 p-1';
            delBtn.innerHTML = '<i class="fas fa-trash-alt text-xs"></i>'; delBtn.onclick = function() { openDeleteConfirmModal('SINGLE', game.id); };
            rightDiv.appendChild(delBtn); contentRow.appendChild(leftDiv); contentRow.appendChild(rightDiv); item.appendChild(contentRow);
            return item;
        }

        // [Utility Functions]
        function getBallColorClass(num) {
            num = parseInt(num); if (num <= 10) return 'ball-yellow'; if (num <= 20) return 'ball-blue'; if (num <= 30) return 'ball-red'; if (num <= 40) return 'ball-gray'; return 'ball-green';
        }
        function displayNumbers(numbers) {
            generatedBallsArea.innerHTML = '';
            numbers.forEach((num, index) => { const ball = document.createElement('div'); ball.className = `lotto-ball ${getBallColorClass(num)}`; ball.textContent = num; ball.style.animationDelay = `${index * 0.1}s`; generatedBallsArea.appendChild(ball); });
        }
        function showGlobalResult(title, desc, colorClass) {
            globalRankTitle.textContent = title; globalRankTitle.className = `text-2xl font-bold mb-1 mt-2 ${colorClass}`; globalRankDesc.innerHTML = desc; 
            globalResultOverlay.classList.remove('hidden'); globalResultOverlay.style.opacity = '0'; setTimeout(() => { globalResultOverlay.style.transition = 'opacity 0.3s'; globalResultOverlay.style.opacity = '1'; }, 10);
        }
        function closeGlobalResult() { globalResultOverlay.classList.add('hidden'); }
        
        // ... (Modal/Toast/Settings/Scan UI functions remain same as before, ensuring robust handling) ...
        function openDeleteConfirmModal(type, id = null) {
            const currentRoundCount = historyData.filter(g => g.round === currentRound).length;
            if (type === 'ALL' && currentRoundCount === 0) { showToast("ì‚­ì œí•  ì´ë²ˆ íšŒì°¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            deleteTargetId = id; 
            if (type === 'ALL') { deleteModalTitle.textContent = `ğŸ—‘ï¸ ${currentRound}íšŒì°¨ ê¸°ë¡ ì „ì²´ ì‚­ì œ`; deleteModalDesc.innerHTML = `ì •ë§ <strong>${currentRound}íšŒì°¨</strong>ì˜ ëª¨ë“  ë²ˆí˜¸ ìƒì„± ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`; }
            else { deleteModalTitle.textContent = "ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ"; deleteModalDesc.innerHTML = "ì„ íƒí•œ ë²ˆí˜¸ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; }
            deleteConfirmModal.classList.remove('hidden'); setTimeout(() => { deleteConfirmModal.classList.add('opacity-100'); deleteConfirmModal.querySelector('div').classList.remove('scale-95'); deleteConfirmModal.querySelector('div').classList.add('scale-100'); }, 10);
        }
        function closeDeleteConfirmModal() { deleteConfirmModal.classList.remove('opacity-100'); deleteConfirmModal.querySelector('div').classList.remove('scale-100'); deleteConfirmModal.querySelector('div').classList.add('scale-95'); setTimeout(() => { deleteConfirmModal.classList.add('hidden'); }, 300); deleteTargetId = null; }
        function confirmDelete() {
            if (deleteTargetId) { deleteGameFromData(deleteTargetId); showToast("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); }
            else { clearCurrentRoundHistory(); generatedBallsArea.innerHTML = '<span class="text-gray-500 text-xs">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</span>'; currentNumbers = []; showToast(`${currentRound}íšŒì°¨ ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`); }
            closeDeleteConfirmModal();
        }
        function copyNumbers() {
            if (currentNumbers.length === 0) { showToast("ë¨¼ì € ë²ˆí˜¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."); return; }
            const textToCopy = currentNumbers.join(', '); const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = 'fixed'; textArea.style.left = '-9999px'; document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); showToast("ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + textToCopy); } catch (err) { showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); } document.body.removeChild(textArea);
        }
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast'); document.getElementById('toast-msg').textContent = message;
            const icon = toast.querySelector('i'); if (isError) { toast.classList.remove('bg-gray-800'); toast.classList.add('bg-red-600'); icon.className = "fas fa-exclamation-circle"; } else { toast.classList.remove('bg-red-600'); toast.classList.add('bg-gray-800'); icon.className = "fas fa-check-circle"; }
            
            // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì·¨ì†Œ
            if (toastTimeoutId) {
                clearTimeout(toastTimeoutId);
            }

            toast.style.opacity = '1';

            // ìƒˆë¡œìš´ íƒ€ì´ë¨¸ ì„¤ì •
            toastTimeoutId = setTimeout(() => {
                toast.style.opacity = '0';
                toastTimeoutId = null; // íƒ€ì´ë¨¸ ì¢…ë£Œ í›„ ID ì´ˆê¸°í™”
            }, 10000);
        }
        function openManualInput() { manualSelection = new Set(); updateManualUI(); const grid = manualInputModal.querySelector('.grid'); grid.innerHTML = ''; for(let i=1; i<=45; i++) { const btn = document.createElement('div'); btn.className = 'select-ball'; btn.textContent = i; btn.onclick = () => toggleManualNumber(i, btn); grid.appendChild(btn); } manualInputModal.classList.remove('hidden'); setTimeout(() => { manualInputModal.classList.add('opacity-100'); manualInputModal.querySelector('div').classList.remove('scale-95'); manualInputModal.querySelector('div').classList.add('scale-100'); }, 10); }
        function toggleManualNumber(num, btn) { if (manualSelection.has(num)) { manualSelection.delete(num); btn.classList.remove('selected'); btn.style.background = ''; btn.style.border = ''; } else { if (manualSelection.size >= 6) { showToast("6ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", true); return; } manualSelection.add(num); btn.classList.add('selected'); if (num <= 10) btn.style.background = '#fbc400'; else if (num <= 20) btn.style.background = '#69c'; else if (num <= 30) btn.style.background = '#ff7272'; else if (num <= 40) btn.style.background = '#a5a5a5'; else btn.style.background = '#b0d840'; btn.style.borderColor = 'transparent'; } updateManualUI(); }
        function updateManualUI() { document.getElementById('manual-count').textContent = manualSelection.size; const saveBtn = document.getElementById('manual-save-btn'); if (manualSelection.size === 6) { saveBtn.disabled = false; saveBtn.classList.remove('bg-gray-300', 'cursor-not-allowed'); saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700'); } else { saveBtn.disabled = true; saveBtn.classList.add('bg-gray-300', 'cursor-not-allowed'); saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700'); } }
        function resetManualSelection() { manualSelection.clear(); const btns = manualInputModal.querySelectorAll('.select-ball'); btns.forEach(btn => { btn.classList.remove('selected'); btn.style.background = ''; btn.style.borderColor = ''; }); updateManualUI(); }
        function saveManualInput() { if (manualSelection.size !== 6) return; currentNumbers = Array.from(manualSelection).sort((a, b) => a - b); displayNumbers(currentNumbers); addGameToData(currentNumbers, "ìˆ˜ë™ ì…ë ¥"); closeManualInput(); showToast("ìˆ˜ë™ ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); }
        function closeManualInput() { manualInputModal.classList.remove('opacity-100'); manualInputModal.querySelector('div').classList.remove('scale-100'); manualInputModal.querySelector('div').classList.add('scale-95'); setTimeout(() => { manualInputModal.classList.add('hidden'); }, 300); }
        
        function openSettings() { settingsModal.classList.remove('hidden'); setTimeout(() => { settingsModal.classList.add('opacity-100'); settingsModal.querySelector('div').classList.remove('scale-95'); settingsModal.querySelector('div').classList.add('scale-100'); }, 10); if (userApiKey) { userApiKeyInput.value = userApiKey; } notificationToggle.checked = isNotificationEnabled; }
        function closeSettings() { settingsModal.classList.remove('opacity-100'); settingsModal.querySelector('div').classList.remove('scale-100'); settingsModal.querySelector('div').classList.add('scale-95'); setTimeout(() => { settingsModal.classList.add('hidden'); }, 300); }
        function saveApiKey() { const inputKey = userApiKeyInput.value.trim(); userApiKey = inputKey; localStorage.setItem('user_gemini_key', inputKey); showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); closeSettings(); updateScanButtonState(); }
        function updateScanButtonState() { const hasKey = userApiKey || apiKey; const scanBtn = document.getElementById('scan-btn'); const keyBadge = document.getElementById('key-badge'); if (hasKey) { scanBtn.classList.remove('bg-gray-400'); scanBtn.classList.add('bg-teal-500', 'hover:bg-teal-600'); keyBadge.classList.add('hidden'); } else { scanBtn.classList.remove('bg-teal-500', 'hover:bg-teal-600'); scanBtn.classList.add('bg-gray-400'); keyBadge.classList.remove('hidden'); } }
        function handleScanClick() { const hasKey = userApiKey || apiKey; if (!hasKey) { showToast("ìŠ¤ìº” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •(âš™ï¸)ì—ì„œ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", true); } else { triggerImageUpload(); } }
        function triggerImageUpload() { document.getElementById('image-input').click(); }
        function handleImageUpload(e) { const file = e.target.files[0]; if (!file) return; scanLoader.style.display = 'flex'; scanMessage.textContent = "ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘..."; scanSubMessage.textContent = "AIê°€ ë¡œë˜ ìš©ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤"; const reader = new FileReader(); reader.onload = function(event) { const img = new Image(); img.onload = function() { processImage(img); }; img.src = event.target.result; }; reader.readAsDataURL(file); e.target.value = ''; }
        function processImage(img) { const canvas = document.getElementById('scan-canvas'); const context = canvas.getContext('2d'); const scaleFactor = 1.5; canvas.width = img.width * scaleFactor; canvas.height = img.height * scaleFactor; context.scale(scaleFactor, scaleFactor); context.drawImage(img, 0, 0); const imageData = context.getImageData(0, 0, canvas.width, canvas.height); const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" }); if (code) { const parsedGames = parseLottoQR(code.data); if (parsedGames && parsedGames.length > 0) { finishScan(parsedGames, "QR ìŠ¤ìº”"); return; } } scanMessage.textContent = "AI ë¶„ì„ ì¤‘..."; scanSubMessage.textContent = "Geminiê°€ ë²ˆí˜¸ë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤..."; runGeminiAnalysis(canvas.toDataURL("image/jpeg", 0.8)); }
        async function runGeminiAnalysis(base64Image) { try { const prompt = "Analyze this image and extract ONLY the lottery numbers..."; const text = await callGeminiAPI(prompt, base64Image); const extractedGames = parseGeminiResponse(text); if (extractedGames.length > 0) { finishScan(extractedGames, "AI ìŠ¤ìº”"); } else { scanLoader.style.display = 'none'; showToast("ìˆ«ìë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ì…ë ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”!", true); } } catch (err) { console.error(err); scanLoader.style.display = 'none'; showToast("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (í‚¤ ì„¤ì • í™•ì¸ í•„ìš”)", true); if (err.message.includes('400') || err.message.includes('401') || err.message.includes('403')) { setTimeout(() => openSettings(), 1500); } } }
        async function callGeminiAPI(prompt, base64Image) { const keyToUse = userApiKey || apiKey; if (!keyToUse) { showToast("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤...", true); throw new Error("Missing API Key"); } const cleanBase64 = base64Image.split(',')[1]; const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`; const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } } ] }] }; const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { throw new Error(`Gemini API Error: ${response.status}`); } const data = await response.json(); return data.candidates[0].content.parts[0].text; }
        function parseGeminiResponse(text) { const games = []; const lines = text.split('\n'); lines.forEach(line => { const numsMatch = line.match(/\d+/g); if (!numsMatch) return; const validNums = numsMatch.map(n => parseInt(n)).filter(n => n >= 1 && n <= 45); const uniqueNums = [...new Set(validNums)]; if (uniqueNums.length >= 6) { const gameNums = uniqueNums.slice(0, 6).sort((a, b) => a - b); let label = 'ìë™'; const labelMatch = line.match(/([A-E])[:.)]/i); if (labelMatch) { label = labelMatch[1].toUpperCase(); } else if (games.length < 5) { const labels = ['A', 'B', 'C', 'D', 'E']; label = labels[games.length]; } games.push({ label: label, numbers: gameNums }); } }); return games; }
        function finishScan(games, method) { scanLoader.style.display = 'none'; closeGlobalResult(); if (games.length > 0) { currentNumbers = games[0].numbers; displayNumbers(currentNumbers); } for (let i = games.length - 1; i >= 0; i--) { const label = games[i].label.replace('Game ', '').replace('Auto Detect ', 'ìë™ '); addGameToData(games[i].numbers, `${method} ${label}`); } showToast(`${games.length}ê°œì˜ ê²Œì„ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤!`); }
        function parseLottoQR(url) { try { if (!url.includes('dhlottery.co.kr') || !url.includes('v=')) return null; let params = url.split('v=')[1]; if (!params) return null; if (params.includes('&')) params = params.split('&')[0]; const cleanStr = params.replace(/[^0-9]/g, ''); if (cleanStr.length < 16) return null; const numbersStr = cleanStr.substring(4); const games = []; const gameLabels = ['A', 'B', 'C', 'D', 'E']; for (let i = 0; i < numbersStr.length; i += 12) { const chunk = numbersStr.substring(i, i + 12); if (chunk.length < 12) break; const nums = []; for (let j = 0; j < 12; j += 2) nums.push(parseInt(chunk.substring(j, j + 2))); if (nums.some(n => n < 1 || n > 45)) continue; games.push({ label: gameLabels[games.length] || '?', numbers: nums.sort((a, b) => a - b) }); if (games.length >= 5) break; } return games; } catch (e) { return null; } }
        function toggleNotification(checkbox) { isNotificationEnabled = checkbox.checked; localStorage.setItem('lotto_noti_enabled', isNotificationEnabled); if (isNotificationEnabled) { requestNotificationPermission(); startNotificationScheduler(); showToast("í† ìš”ì¼ ë°¤ 9ì‹œì— ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦´ê²Œìš”! ğŸ””"); } else { showToast("ì•Œë¦¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); } }
        function requestNotificationPermission() { if (!("Notification" in window)) { showToast("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", true); return; } if (Notification.permission !== "granted") { Notification.requestPermission().then(permission => { if (permission !== "granted") { notificationToggle.checked = false; isNotificationEnabled = false; localStorage.setItem('lotto_noti_enabled', false); showToast("ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.", true); } }); } }
        function startNotificationScheduler() { checkWeeklyNotification(); setInterval(checkWeeklyNotification, 60000); }
        function checkWeeklyNotification() { if (!isNotificationEnabled) return; const now = new Date(); const day = now.getDay(); const hour = now.getHours(); const minute = now.getMinutes(); if (day === 6 && hour === 21 && minute === 0) { const lastSent = localStorage.getItem('last_noti_date'); const todayStr = now.toDateString(); if (lastSent !== todayStr) { sendNotification(); localStorage.setItem('last_noti_date', todayStr); } } }
        function sendNotification() { if (Notification.permission === "granted") { const options = { body: "í–‰ìš´ì˜ ì£¼ì¸ê³µì´ ë˜ì…¨ë‚˜ìš”? ì§€ê¸ˆ ë°”ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!", icon: "https://cdn-icons-png.flaticon.com/512/1042/1042319.png", badge: "https://cdn-icons-png.flaticon.com/512/1042/1042319.png", vibrate: [200, 100, 200] }; if (navigator.serviceWorker.controller) { navigator.serviceWorker.ready.then(function(registration) { registration.showNotification("ğŸ€ ë¡œë˜ ì¶”ì²¨ ê²°ê³¼ í™•ì¸", options); }); } else { new Notification("ğŸ€ ë¡œë˜ ì¶”ì²¨ ê²°ê³¼ í™•ì¸", options); } } }

        async function fetchLatestResult() {
            const round = document.getElementById('round-input').value;
            if (winResults[round]) {
                localStorage.setItem('lotto_current_round', round); showModal();
                const cachedData = winResults[round]; renderModalContent(cachedData);
                const winArr = [cachedData.drwtNo1, cachedData.drwtNo2, cachedData.drwtNo3, cachedData.drwtNo4, cachedData.drwtNo5, cachedData.drwtNo6];
                currentWinData = cachedData; checkWinningsInHistory(winArr, cachedData.bnusNo, true); return;
            }
            showModal();
            modalContent.innerHTML = `<div class="animate-pulse flex space-x-2 justify-center items-center h-16"><div class="h-8 w-8 bg-gray-200 rounded-full"></div><div class="h-8 w-8 bg-gray-200 rounded-full"></div><div class="h-8 w-8 bg-gray-200 rounded-full"></div><div class="h-8 w-8 bg-gray-200 rounded-full"></div><div class="h-8 w-8 bg-gray-200 rounded-full"></div><div class="h-8 w-8 bg-gray-200 rounded-full"></div></div><p class="text-gray-500 text-sm mt-2">${round}íšŒì°¨ ê²°ê³¼ í™•ì¸ ì¤‘...</p>`;

            const startDate = new Date('2002-12-07T00:00:00');
            const drawDate = new Date(startDate.getTime() + (round - 1) * 7 * 24 * 60 * 60 * 1000);
            drawDate.setHours(21, 0, 0, 0); const now = new Date();

            if (drawDate > now) {
                modalContent.innerHTML = `<div class="text-center py-4"><i class="fas fa-clock text-4xl text-gray-300 mb-2"></i><h4 class="text-lg font-bold text-gray-700">ì¶”ì²¨ ëŒ€ê¸° ì¤‘</h4><p class="text-gray-500 text-sm mt-1">${round}íšŒì°¨ ì¶”ì²¨ì¼ì€<br>${drawDate.toLocaleDateString()} ì…ë‹ˆë‹¤.</p></div>`;
                return;
            }

            try {
                // ìš”ì²­í•˜ì‹  selectPstLt645Info.do API ì ìš©
                const timestamp = new Date().getTime();
                const targetUrl = `https://www.dhlottery.co.kr/lt645/selectPstLt645Info.do?srchLtEpsd=${round}&_=${timestamp}`;
                
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const jsonResponse = await response.json();

                // selectPstLt645Info.do ì‘ë‹µ êµ¬ì¡° ì²˜ë¦¬
                if (jsonResponse.data && jsonResponse.data.list && jsonResponse.data.list.length > 0) {
                    const lottoData = jsonResponse.data.list[0];
                    
                    // ë‚ ì§œ í¬ë§·íŒ… (YYYYMMDD -> YYYY-MM-DD)
                    const dateStr = String(lottoData.ltRflYmd);
                    const formattedDate = dateStr.length === 8 ? `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}` : dateStr;

                    const mappedData = {
                        drwNo: lottoData.ltEpsd, 
                        drwNoDate: formattedDate,
                        drwtNo1: lottoData.tm1WnNo, 
                        drwtNo2: lottoData.tm2WnNo, 
                        drwtNo3: lottoData.tm3WnNo,
                        drwtNo4: lottoData.tm4WnNo, 
                        drwtNo5: lottoData.tm5WnNo, 
                        drwtNo6: lottoData.tm6WnNo,
                        bnusNo: lottoData.bnsWnNo
                    };
                    
                    winResults[round] = mappedData;
                    localStorage.setItem('lotto_win_results', JSON.stringify(winResults));
                    localStorage.setItem('lotto_current_round', round); 
                    currentWinData = mappedData; 
                    renderModalContent(mappedData);
                    const winArr = [mappedData.drwtNo1, mappedData.drwtNo2, mappedData.drwtNo3, mappedData.drwtNo4, mappedData.drwtNo5, mappedData.drwtNo6];
                    checkWinningsInHistory(winArr, mappedData.bnusNo, true);
                } else if (jsonResponse.returnValue === 'success') {
                     // í˜¹ì‹œ common.do êµ¬ì¡°ë¡œ ì˜¤ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ í´ë°±
                    const lottoData = jsonResponse;
                    const mappedData = {
                        drwNo: lottoData.drwNo, drwNoDate: lottoData.drwNoDate,
                        drwtNo1: lottoData.drwtNo1, drwtNo2: lottoData.drwtNo2, drwtNo3: lottoData.drwtNo3,
                        drwtNo4: lottoData.drwtNo4, drwtNo5: lottoData.drwtNo5, drwtNo6: lottoData.drwtNo6,
                        bnusNo: lottoData.bnusNo
                    };
                    winResults[round] = mappedData;
                    localStorage.setItem('lotto_win_results', JSON.stringify(winResults));
                    localStorage.setItem('lotto_current_round', round);
                    currentWinData = mappedData;
                    renderModalContent(mappedData);
                    const winArr = [mappedData.drwtNo1, mappedData.drwtNo2, mappedData.drwtNo3, mappedData.drwtNo4, mappedData.drwtNo5, mappedData.drwtNo6];
                    checkWinningsInHistory(winArr, mappedData.bnusNo, true);
                } else { 
                    throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); 
                }
            } catch (e) {
                console.warn("Lotto API Fetch Failed:", e);
                showToast("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê°€ìƒ ê²°ê³¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤. (CORS ë“±)", true);
                
                const winNumbers = new Set(); while(winNumbers.size < 6) winNumbers.add(Math.floor(Math.random() * 45) + 1);
                const winArr = Array.from(winNumbers).sort((a,b)=>a-b);
                const bonus = Math.floor(Math.random() * 45) + 1;
                const year = drawDate.getFullYear(); const month = String(drawDate.getMonth() + 1).padStart(2, '0'); const day = String(drawDate.getDate()).padStart(2, '0');
                const simulatedDate = `${year}-${month}-${day} (ëª¨ì˜)`;
                const mockData = { drwNo: round, drwtNo1: winArr[0], drwtNo2: winArr[1], drwtNo3: winArr[2], drwtNo4: winArr[3], drwtNo5: winArr[4], drwtNo6: winArr[5], bnusNo: bonus, drwNoDate: simulatedDate };
                currentWinData = mockData;
                winResults[round] = mockData; // Cache mock data
                localStorage.setItem('lotto_win_results', JSON.stringify(winResults));
                renderModalContent(mockData);
                checkWinningsInHistory(winArr, bonus, true);
            }
        }

        function checkWinningsInHistory(winArr, bonus, showMessage = true) {
            const items = document.querySelectorAll('.history-item');
            items.forEach(item => {
                if (!item.dataset.numbers) return;
                const myNumbers = JSON.parse(item.dataset.numbers);
                applyWinStyleToItem(item, winArr, bonus, myNumbers);
            });
            if(currentWinData) calculateAndShowSummary(currentWinData);
            if(showMessage) showToast("ê²°ê³¼ í™•ì¸ ì™„ë£Œ!");
        }

        // Restored Modal Functions
        function renderModalContent(data) {
            const numbers = [data.drwtNo1, data.drwtNo2, data.drwtNo3, data.drwtNo4, data.drwtNo5, data.drwtNo6];
            let ballsHtml = '<div class="flex justify-center gap-1 mb-4">';
            numbers.forEach(num => {
                ballsHtml += `<div class="lotto-ball small-ball ${getBallColorClass(num)}">${num}</div>`;
            });
            ballsHtml += '</div>';

            modalContent.innerHTML = `
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-2">${data.drwNoDate} ì¶”ì²¨</p>
                    <h4 class="text-2xl font-bold text-indigo-600 mb-4">ì œ ${data.drwNo}íšŒ</h4>
                    ${ballsHtml}
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <span class="text-gray-600 font-bold">ë³´ë„ˆìŠ¤</span>
                        <div class="lotto-ball small-ball ${getBallColorClass(data.bnusNo)}">${data.bnusNo}</div>
                    </div>
                </div>
            `;
        }

        function showModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                resultModal.classList.add('opacity-100');
                resultModal.querySelector('div').classList.remove('scale-95');
                resultModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            resultModal.classList.remove('opacity-100');
            resultModal.querySelector('div').classList.remove('scale-100');
            resultModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                resultModal.classList.add('hidden');
            }, 300);
        }

        resultModal.addEventListener('click', (e) => { if (e.target === resultModal) closeModal(); });
        init();
    </script>
</body>
</html>
